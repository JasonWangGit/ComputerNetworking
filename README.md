# 计算机网络（韩立刚）

## 分层重点协议整理

- 分层的意义：解耦

- **应用层**（应用层 ：能够产生网络流量且能和用户交互的应用程序 + 表示层：加密、压缩 + 会话层：服务器和客户端建立的会话）.
  - HTTP
  - FTP
  - DNS
  - SMTP
  - PoP3

- **运输层**（七层中也称传输层）：可靠传输、不可靠传输
  - TCP
  - UDP

- **网络层**（四层中也称网络层）：IP地址编址、选择最佳路径
  - 网际协议 **IP（Internet Protocol）** ：封装在IP数据报首部
    - 地址解析协议 **ARP （Address Resolution Protocol）** ：封装在IP数据报
      - IP地址 → 物理地址
    - 逆地址解析协议 **RARP （Reverse Address Resolution Protocol）** ：封装在IP数据报
      - 物理地址 → IP地址
    - 网际控制报文协议 **ICMP （Internet Control Message Protocol）**：封装在IP数据报
      - 为了提高 IP 数据报交付成功的机会
    - 网际组管理协议 **IGMP （Internet Group Management Protocol）**：封装在IP数据报
      - 为了使路由器知道多播组成员的信息
  - 内部网关协议 **RIP （Routing Information Protocol）**：封装在UDP数据报
    - RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
  - 内部网关协议 **OSPF （Open Shortest Path First）**：封装在IP数据报
    - 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法
  - 外部网关协议 **BGP（Border Gateway Protocol）**：封装在TCP数据
    - BGP 是不同自治系统的路由器之间交换路由信息的协议
- **数据链路层**（四层中与物理层也合称网络接口层）：封装数据、添加物理层地址（MAC）
  - 封装成帧（首部、尾部）、透明传输（“转义”思想）、差错控制（循环冗余检验 CRC）
  - 点对点协议 **PPP （Point-to-Point Protocol）**
    - 一个将 IP 数据报封装到串行链路的方法
    - 链路控制协议 **LCP （Link Control Protocol）**
    - 网络控制协议 **NCP （Network Control Protocol）**
  - 载波监听多点接入/碰撞检测 **CSMA/CD（Carrier Sense Multiple Access with Collision Detection）**
    - 解决总线网问题
- **物理层**（四层中与数据链路层也合称网络接口层）：电压、接口标准
  - 机械特性（形状、尺寸）、电气特性（电压范围）、功能特性（电平意义）、过程特性（事件顺序）
  - 信号（基带、带通）、通信（单工、半双工、全双工）、信道（对传输媒体的抽象）、传输媒体（双绞线、同轴电缆、光缆、无线传输）、复用技术（频分、波分、时分、统计时分、码分）

## 第 1 章 概述

### 1.1 计算机网络在信息时代中的作用

暂无内容。

### 1.2 因特网概述

#### 术语

- 结点（node）
  - 二叉树中叫节点，网络中叫结点
- 链路（link）
- 主机（host）
- 互联网（internet）
- 因特网（Internet）
  - 当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用 TCP/IP 协议族作为通信的规则
- 因特网服务提供者ISP（Internet Service Provider）
- 万维网WWW（World Wide Web）

### 1.3 因特网的组成

#### 因特网的边缘部分与核心部分

- 边缘部分：由所有连接在因特网上的主机（端系统 end system）组成
  - 两种通信方式
    - 客户服务器方式（C/S 方式）：Client/Server，客户是服务的请求方，服务器是服务的提供方
    - 对等方式（P2P 方式）：Peer-to-Peer，两个主机在通信时并不区分哪一个是服务请求方还是服务提供方
- 核心部分：由大量网络和连接这些网络的路由器组成
  - 在网络核心部分起特殊作用的是路由器（router）
    - 路由器是实现分组交换（packet switching）的关键构件，其任务是转发收到的分组

### 1.4 计算机网络在我国的发展

暂无内容。

### 1.5 计算机网络的类别

暂无内容。

### 1.6 计算机网络的性能

#### 计算机网络的性能指标

- 比特（bit）是计算机中数据量的单位，也是信息论中使用的信息量的单位
  - bit 来源于binary digit，意思是一个“二进制数字”，因此一个比特就是二进制数字中的 一个1或0
- **速率**即数据率（data rate）或比特率（bit rate）是计算机网络中最重要的一个性能指标。速率的单位是 b/s，或kb/s, Mb/s, Gb/s 等
- **带宽**（bandwidth）本来是指信号具有的频带宽度，单位是赫（或千赫、兆赫、 吉赫等）
  - 现在“带宽”是数字信道所能传送的 “最高数据率”的同义语，单位是“比特每秒”，或 b/s （bit/s）

$$
在计算机界，K = 2^{10} = 1024， M = 2^{20}， G = 2^{30}， T = 2^{40}
$$

- **吞吐量**（throughput）表示在单位时间内通过某个网络（或信道、接口）的数据量

- **时延**（delay或 latency）

  - 总时延 = 发送时延 + 传播时延 + 处理时延 + 处理时延
  - 传输时延（发送时延）：发送数据时， 数据块从结点进入到传输媒体所需要的时间
    - 发送时延 = 数据块长度（比特） / 信道带宽（比特/秒）

  - 传播时延：电磁波在信道中需要传播一定的距离而花费的时间
    - 传播时延 = 信道长度（米） / 信号在信道上的传播速率（米/秒）
  - 处理时延：交换结点为存储转发而进行一些必要的处理所花费的时间
  - 排队时延：结点缓存队列中分组排队所经历的时延

- 链路的**时延带宽积**又称为以比特为单位的链路长度

  - 时延带宽积 = 传播时延 × 带宽

- **利用率**

  - 信道利用率指出某信道有百分之几的时间是被利用的（有数据通过）
    - 完全空闲的信道的利用率是零
  - 网络利用率则是全网络的信道利用率的加权平均值
  - 根据排队论的理论，当某信道的利用率增大时，该信道引起的时延也就迅速增加

### 1.7 计算机网络的体系结构

#### 分层的好处（解耦）

- 各层之间是独立的
- 灵活性好
- 结构上可分割开
- 易于实现和维护
- 能促进标准化工作

#### OSI

- 应用层（Application）
  - 能够产生网络流量且能和用户交互的应用程序

- 表示层（Presentation）
  - 加密、压缩

- 会话层（Session）
  - 服务器和客户端建立的会话
- 传输层（Transport）
  - 可靠传输、不可靠传输

- 网络层（Network）
  - IP地址编址、选择最路径

- 数据链路层（Data Link）
  - 封装数据、添加物理层地址（MAC）

- 物理层（Physical）
  - 电压、接口标准

#### TCP/IP

- 应用层（Application）
  - 应用层 + 表示层 + 会话层
- 运输层（Transport）
- 网际层（Internet）
  - 网络层
- 网络接口层（Network Access）
  - 数据链路层 + 物理层

#### 五层协议

- 应用层（Application）
- 运输层（Transport）
- 网络层（Network）
- 数据链路层（Data Link）
- 物理层（Physical）

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E4%B8%BB%E6%9C%BA1%E5%90%91%E4%B8%BB%E6%9C%BA2%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE.png" alt="主机1向主机2发送数据" width="500" height="300" />

## 第 2 章 物理层

### 2.1 物理层的基本概念

物理层的主要任务描述为确定与传输媒体的接口的一些特性。

- 机械特性：指明接口所用接线器的形状和尺寸 、引线数目和排列、固定和锁定装置等等
- 电气特性：指明在接口电缆的各条线上出现的电压的范围
- 功能特性：指明某条线上出现的某一电平的电压表示何种意义
- 过程特性：指明对于不同功能的各种可能事件的出现顺序

### 2.2 数据通信的基础知识

#### 数据通信系统的模型

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A8%A1%E5%9E%8B.png" alt="数据通信系统的模型" width="500" height="300" />

#### 术语

- 数据（data）
- 信号（signal）
- 模拟的（analogous）
- 数字的（digital）
- 码元（code）：在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形

#### 有关信号的几个基本概念

- 单向通信（单工通信）
- 双向交替通信（半双工通信）
- 双向同时通信（全双工通信）

#### 基带（baseband）信号和带通（band pass）信号

- 基带信号（即基本频带信号）
- 带通信号：把基带信号经过载波调制后，把信号的频率范围搬移到较高的频段以便在信道中传输（即仅在一 段频率范围内能够通过信道）

#### 几种最基本的调制方法

- 调幅（AM）
  - 正交振幅调制 QAM （Quadrature Amplitude Modulation）
- 调频（FM）
- 调相（PM） 

#### 奈氏准则

- 1924 年，奈奎斯特（Nyquist）就推导出了著名的奈氏准则
- 他给出了在假定的理想条件下，为了避免码间串扰，码元的传输速率的上限值
- 在任何信道中，码元传输的速率是有上限的， 否则就会出现码间串扰的问题，使接收端对码元的判决（即识别）成为不可能

#### 香农公式

- 香农（Shannon）用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率
- 信道的极限信息传输速率 C 可表达为

$$
C = log_2(1 + S / N)
$$

- W 为信道的带宽（以 Hz 为单位）
- S 为信道内所传信号的平均功率
- N 为信道内部的高斯噪声功率

##### 香农公式表明

- 信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高
- 只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输
- 若信道带宽 W 或信噪比 S/N 没有上限（当然实际信道不可能是这样的）
  - 则信道的极限信息传输速率 C 也就没有上限
- 实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少
- 对于频带宽度已确定的信道，如果信噪比不能再提高了，并且码元传输速率也达到了上限值，那么还有办法提高信息的传输速率
  - 这就是用编码的方法让每一个码元携带更多比特的信息量

### 2.3 物理层下面的传输媒体

#### 导向传输媒体

- 双绞线 
  - 屏蔽双绞线 STP （Shielded Twisted Pair） 
  - 无屏蔽双绞线 UTP （Unshielded Twisted Pair） 
- 同轴电缆 
  - 50 Ω同轴电缆 
  - 75 Ω同轴电缆 
- 光缆
  - 多模光纤
  - 单模光纤

#### 非导向传输媒体

- 短波通信主要是靠电离层的反射，但短波信道的通信质量较差
- 微波在空间主要是直线传播
  - 地面微波接力通信
  - 卫星通信

### 2.4 信道复用技术

- 频分复用FDM （Frequency Division Multiplexing）

- 时分复用TDM （Time Division Multiplexing） 
  - 时分复用可能会造成线路资源的浪费

- 统计时分复用STDM （Statistic TDM） 
  - 避免时分复用的浪费
- 波分复用 WDM （Wavelength Division Multiplexing）
  - 波分复用就是光的频分复用
- 码分复用 CDM （Code Division Multiplexing）
  - 码分多址 CDMA （Code Division Multiple Access）
    - 各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰
    - 这种系统发送的信号有很强的抗干扰能力， 其频谱类似于白噪声，不易被敌人发现
    - 每一个比特时间划分为 m 个短的间隔，称为码片（chip）
    - 每个站分配的码片序列不仅必须各不相同， 并且还必须互相正交（orthogonal）
    - 在实用的系统中是使用伪随机码序列

### 2.5 数字传输系统

- 脉码调制 PCM 体制
  - 脉码调制 PCM 体制最初是为了在电话局之间的中继线上传送多路的电话
- 同步光纤网 SONET 和同步数字系列 SDH 
  - 一般可认为 SDH 与 SONET 是同义词

### 2.6 宽带接入技术

- xDSL 技术
  - 就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务
- 光纤同轴混合网 HFC （Hybrid Fiber Coax）
  - HFC 网是在目前覆盖面很广的有线电视网 CATV 的基础上开发的一种居民宽带接入网
- FTTx 技术
  - FTTx（光纤到……）也是一种实现宽带居民接入网的方案

## 第 3 章 数据链路层

数据链路层使用的信道主要有以下两种类型：

- 点对点信道：这种信道使用一对一的点对点通信方式
- 广播信道：这种信道使用一对多的广播通信方式，因此过程比较复杂
  - 广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据收发

### 3.1 使用点对点信道的数据链路层

#### 数据链路和帧

- 链路（link）是一条无源的点到点的物理线路段，中间没有任何其他的交换结点
  - 一条链路只是一条通路的一个组成部分
- 数据链路（data link） 除了物理线路外，还必须有通信协议来控制这些数据的传输
  - 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件
    - 一般的适配器都包括了数据链路层和物理层这两层的功能。
  - 若把实现这些协议的硬件和软件加到链路上，就构成了数据链路
  - 数据链路层传送的是帧

#### 三个基本问题

- 封装成帧
  - 封装成帧（framing）就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧
    - 确定帧的界限
  - 首部和尾部的一个重要作用就是进行帧定界
- 透明传输
  - 发送端的数据链路层在数据中出现控制字符 “SOH”或“EOT”的前面插入一个转义字符 “ESC”（其十六进制编码是 1B）
  - 字节填充（byte stuffing）或字符填充（character stuffing）
    - 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符
  - 如果转义字符也出现数据当中，那么应在转义字符前面插入一个转义字符
    - 当接收端收到连续的两个转义字符时，就删除其中前面的一个
- 差错控制
  - 在传输过程中可能会产生比特差错：1 可能会变成 0 而 0 也可能变成 1
  - 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率 BER （Bit Error Rate）
    - 误码率与信噪比有很大的关系
  - 在数据链路层传送的帧中，广泛使用了循环冗余检验 CRC 的检错技术
    - 在数据后面添加上的冗余码称为帧检验序列 FCS （Frame Check Sequence）
      - CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码
      - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法
    - 仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受（accept）
    - “无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错” 。 
      - 也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）
    - 要做到“可靠传输”（即发送什么就收到什么） 就必须再加上确认和重传机制

### 3.2 点对点协议 PPP

现在全世界使用得最多的数据链路层协议是点对点协议 PPP （Point-to-Point Protocol）。

- 用户使用拨号电话线接入因特网时，一般都是使用 PPP 协议

#### PPP 协议的组成

-  一个将 IP 数据报封装到串行链路的方法 
- 链路控制协议 LCP （Link Control Protocol）
- 网络控制协议 NCP （Network Control Protocol）

#### PPP 协议的帧格式

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/PPP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="PPP协议的帧格式" width="500" height="300" />

#### 透明传输问题

- 当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的 做法一样）
  - PPP 协议用在 SONET/SDH 链路时，是使用同步传输（一连串的比特连续传送）
    - 这时 PPP 协议采用零比特填充方法来实现透明传输
      - 在发送端，只要发现有 5 个连续 1，则立即填入一个 0
- 当 PPP 用在异步传输时，就使用一种特殊的字符填充法
  - 将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列（0x7D, 0x5E）
  - 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变

### 3.3 使用广播信道的数据链路层

#### 局域网的数据链路层

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。

##### 媒体共享技术

- 静态划分信道 
  - 频分复用、时分复用、波分复用、码分复用 
- 动态媒体接入控制（多点接入） 
  - 随机接入 
  - 受控接入，如多点线路探询（polling），或轮询

##### 以太网的两个标准

- DIX Ethernet V2
- IEEE 802.3（简称为以太网）

##### 数据链路层的两个子层

- ~~逻辑链路控制 LLC（Logical Link Control）子层~~
- 媒体接入控制 MAC（Medium Access Control）子层

##### 适配器的作用

网络接口板又称为通信适配器（adapter） 或网络接口卡 NIC （Network Interface Card），或“网卡”。

- 进行串行/并行转换
- 对数据进行缓存
- 在计算机的操作系统安装设备驱动程序
- 实现以太网协议

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%80%9A%E8%BF%87%E9%80%82%E9%85%8D%E5%99%A8%E5%92%8C%E5%B1%80%E5%9F%9F%E7%BD%91%E8%BF%9B%E8%A1%8C%E9%80%9A%E4%BF%A1.png" alt="计算机通过适配器和局域网进行通信" width="500" height="300" />

#### CSMA/CD 协议（总线网）

最初的以太网是将许多计算机都连接到一根总线上。当初认为这样的连接方法既简单又可靠， 因为总线上没有有源器件。

##### 以太网的广播方式发送

总线上的每一个工作的计算机都能检测到 B 发送的数据信号。

##### 为了通信的简便以太网采取了两种重要的措施

- 采用较为灵活的无连接的工作方式，即不必先建立连接就可以直接发送数据
- 以太网对发送的数据帧不进行编号，也不要求对方发回确认
  - 这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的

##### 以太网提供的服务：曼彻斯特（Manchester）编码

- 以太网提供的服务是不可靠的交付，即尽最大努力的交付 
- 当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做
  - 差错的纠正由高层来决定。 
  - 如果高层发现丢失了一些数据而进行重 传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送

##### 载波监听多点接入/碰撞检测 CSMA/CD（Carrier Sense Multiple Access with Collision Detection）

- “多点接入”表示许多计算机以多点接入的方式连接在一根总线上。 
- “载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据
  - 如果有，则暂时不要发送数据，以免发生碰撞
  - 总线上并没有什么“载波”
    - 因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号
- “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小
  - 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）
    - 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞
  - 所谓“碰撞”就是发生了冲突
    - 因此“碰撞检测”也称为“冲突检测”
  - 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送， 免得继续浪费网络资源，然后等待一段随机时间后再次发送
  - 争用期（碰撞窗口）
    - 最先发送数据帧的站，在发送数据帧后至多经过时间 2τ（两倍的端到端往返时延） 就可知道发送的数据帧是否遭受了碰撞
  - 二进制指数类型退避算法（truncated binary exponential type）
    - 发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据
  - 最短有效帧长（64 字节）
    - 以太网取 51.2 μs 为争用期的长度
    - 对于 10 Mb/s 以太网，在争用期内可发送 512 bit，即 64 字节
    - 以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突
    - 如果发生冲突，就一定是在发送的前 64 字节之内
    - 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节
    - 以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧
  - 强化碰撞
    - 当发送数据的站一旦发现发生了碰撞时： 
      - 立即停止发送数据
      - 再继续发送若干比特的人为干扰信号（jamming signal），以便让所有用户都知道现在已经发生了碰撞

##### 重要特性

- 使用 CSMA/CD 协议的以太网不能进行全双工通信而只能进行双向交替通信（半双工通信）
- 每个站在发送数据之后的一小段时间内， 存在着遭遇碰撞的可能性
- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率

### 3.4 使用广播信道的以太网

#### 使用集线器的星形拓扑

- 传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线
- 这种以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做集线器（hub） 

##### 集线器的一些特点

- 集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个传统的以太网那样运行
- 使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线
- 集线器很像一个多接口的转发器，工作在物理层

#### 以太网的信道利用率

##### 参数 a

- 要提高以太网的信道利用率，就必须减小 τ 与 T0 之比
- 在以太网中定义了参数 a，它是以太网单程端到端时延 τ 与帧的发送时间 T0 之比

$$
a = \frac{\tau}{T_0}
$$

- a→0 表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高
- a 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低

##### 对以太网参数的要求

- 当数据率一定时，以太网的连线的长度受到限制，否则 τ 的数值会太大
- 以太网的帧长不能太短，否则 T0 的值会太小，使 a 值太大

#### 以太网的 MAC 层

- 在局域网中，硬件地址又称为物理地址， 或 MAC 地址
- 常用的以太网MAC帧格式有两种标准 ： 
  - （最常用）DIX Ethernet V2 标准
  - IEEE 的 802.3 标准

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E4%BB%A5%E5%A4%AA%E7%BD%91%E7%9A%84MAC%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="以太网的MAC帧格式" width="500" height="300" />

##### 48 位的 MAC 地址

- IEEE 的注册管理机构 RA 负责向厂家分配地址字段的前三个字节（即高位 24 位）
- 地址字段中的后三个字节（即低位 24 位）由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址
- 一个地址块可以生成2^24个不同的地址。这种 48 位地址称为 MAC-48，它的通用名称是EUI-48
- “MAC地址”实际上就是适配器地址或适配器标识符EUI-48

##### 适配器检查 MAC 地址

- 适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址
  - 如果是发往本站的帧则收下，然后再进行其他的处理
  - 否则就将此帧丢弃，不再进行其他的处理
- “发往本站的帧”包括以下三种帧： 
  - 单播（unicast）帧（一对一） 
  - 广播（broadcast）帧（一对全体） 
  - 多播（multicast）帧（一对多）

##### 无效的 MAC 帧

- 数据字段的长度与长度字段的值不一致
- 帧的长度不是整数个字节
- 用收到的帧检验序列 FCS 查出有差错
- 数据字段的长度不在 46 ~ 1500 字节之间
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间
- 对于检查出的无效 MAC 帧就简单地丢弃
- 以太网不负责重传丢弃的帧

##### 帧间最小间隔

- 帧间最小间隔为 9.6 μs，相当于 96 bit 的发送 时间
- 一个站在检测到总线开始空闲后，还要等待 9.6 μs 才能再次发送数据
- 这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备

### 3.5 扩展的以太网

- 在物理层扩展局域网
  - 主机使用光纤和一对光纤调制解调器连接到集线器
  - 用多个集线器可连成更大的局域网
    - 用集线器组成更大的局域网都在一个碰撞域中
- 在数据链路层扩展局域网
  - 在数据链路层扩展局域网是使用网桥
    - 网桥工作在数据链路层，它根据 MAC 帧的目的地址对收到的帧进行转发
    - 网桥具有过滤帧的功能
      - 当网桥收到一个帧时， 并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口
    - 网桥使各网段成为隔离开的碰撞域
    - 网桥只适合于用户数不太多（不超过几百个）和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞
      - 这就是所谓的广播风暴
    - 网桥不改变它转发的帧的源地址
  - 用以太网交换机扩展局域网
    - 利用以太网交换机可以很方便地实现虚拟局域网
      - 虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组
      - 虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E8%99%9A%E6%8B%9F%E5%B1%80%E5%9F%9F%E7%BD%91%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="虚拟局域网使用的以太网帧格式" width="500" height="300" />

#### 网桥和集线器（或转发器）不同

- 集线器在转发帧时，不对传输媒体进行检测
- 网桥在转发帧之前必须执行 CSMA/CD 算法
  - 若在发送过程中出现碰撞，就必须停止发送和进行退避

#### 透明网桥

- 目前使用得最多的网桥是透明网桥（transparent bridge）
- “透明”是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的
- 透明网桥是一种即插即用设备，其标准是 IEEE 802.1D
- 网桥应当按照以下自学习算法处理收到的帧和建立转发表

#### 源路由网桥

- 透明网桥容易安装，但网络资源的利用不充分
- 源路由（source route）网桥在发送帧时将详细的路由信息放在帧的首部中
- 源站以广播方式向欲通信的目的站发送一个发现帧， 每个发现帧都记录所经过的路由
- 发现帧到达目的站时就沿各自的路由返回源站
  - 源站在得知这些路由后，从所有可能的路由中选择出 一个最佳路由
  - 凡从该源站向该目的站发送的帧的首部，都必须携带源站所确定的这一路由信息

#### 多接口网桥：以太网交换机

- 交换式集线器常称为以太网交换机（switch）或第二层交换机（表明此交换机工作在数据链路层）
- 以太网交换机通常都有十几个接口
  - 因此，以太网交换机实质上就是一个多接口的网桥，可见交换机工作在数据链路层
- 以太网交换机的每个接口都直接与主机相连，并且一般都工作在全双工方式
- 交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据
- 以太网交换机由于使用了专用的交换结构芯片， 其交换速率就较高
- 独占传输媒体的带宽
  - 对于普通 10 Mb/s 的共享式以太网，若共有 N 个 用户，则每个用户占有的平均带宽只有总带宽（10 Mb/s）的 N 分之一
  - 使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽， 因此对于拥有 N 对接口的交换机的总容量为 N×10 Mb/s
    - 这正是交换机的最大优点。

### 3.6 高速以太网

速率达到或超过 100 Mb/s 的以太网称为高速以太网。

- 100BASE-T 以太网（快速以太网 Fast Ethernet）
  - 可在全双工方式下工作而无冲突发生
    - 因此，不使用 CSMA/CD 协议
  - MAC 帧格式仍然是 802.3 标准规定的
  - 保持最短帧长不变，但将一个网段的最大电缆长度减小到 100 m
  - 帧间时间间隔从原来的 9.6 μs 改为现在 的 0.96 μs
- 吉比特以太网
  - 允许在 1 Gb/s 下全双工和半双工两种方式工作
  - 使用 802.3 协议规定的帧格式
  - 在半双工方式下使用 CSMA/CD 协议 （全双工方式不需要使用 CSMA/CD 协议）
  - 与 10BASE-T 和 100BASE-T 技术向后兼容
- 10 吉比特以太网
  - 10 吉比特以太网与 10 Mb/s，100 Mb/s 和 1 Gb/s 以太网的帧格式完全相同
  - 10 吉比特以太网还保留了 802.3 标准规定的以太网最小和最大帧长，便于升级
  - 10 吉比特以太网不再使用铜线而只使用光纤作为传输媒体
  - 10 吉比特以太网只工作在全双工方式，因此没有争用问题，也不使用 CSMA/CD 协议

## 第 4 章 网络层

### 4.1 网络层提供的两种服务

- 网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务
- 网络在发送分组时不需要先建立连接
  - 每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）
- 网络层不提供服务质量的承诺
  - 即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限
- 由于传输网络不提供端到端的可靠传输服务， 这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）
- 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责（包括差错处理、流量控制等）
- 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用
- 因特网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性

#### 虚电路服务

- H1 发送给 H2 的所有分组都沿着同一条虚电路传送

- 虚电路表示这只是一条逻辑上的连接， 分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接
- 请注意，电路交换的电话通信是先建立了一条真正的连接
  - 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样

#### 数据报服务

- H1 发送给 H2 的分组可能沿着不同路径传送

#### 虚电路服务与数据报服务的对比

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E8%99%9A%E7%94%B5%E8%B7%AF%E6%9C%8D%E5%8A%A1%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AF%B9%E6%AF%94.png" alt="虚电路服务与数据报服务的对比" width="500" height="300" />

### 4.2 网际协议 IP

- 网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一
- 与 IP 协议配套使用的还有四个协议： 
  - 地址解析协议 ARP （Address Resolution Protocol） 
  - 逆地址解析协议 RARP （Reverse Address Resolution Protocol） 
  - 网际控制报文协议 ICMP （Internet Control Message Protocol） 
  - 网际组管理协议 IGMP （Internet Group Management Protocol）

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E7%BD%91%E9%99%85%E5%B1%82%E7%9A%84IP%E5%8D%8F%E8%AE%AE%E5%8F%8A%E9%85%8D%E5%A5%97%E5%8D%8F%E8%AE%AE.png" alt="网际层的IP协议及配套协议" width="500" height="300" />

#### 虚拟互连网络

- 中间设备又称为中间系统或中继（relay）系统
  - 物理层中继系统：转发器（repeater）
    - 集线器
  - 数据链路层中继系统：网桥或桥接器（bridge）
    - 网桥、交换机
    - 当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络
  - 网络层中继系统：路由器（router）
    - 互联网都是指用路由器进行互连的网络
    - 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关
  - 网桥和路由器的混合物：桥路器（brouter）
  - 网络层以上的中继系统：网关（gateway）
    - 网关由于比较复杂，目前使用得较少
- 所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络
- 使用 IP 协议的虚拟互连网络可简称为 IP 网
- 使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样， 而看不见互连的各具体的网络异构细节

#### 分类的 IP 地址

- 每一类地址都由两个固定长度的字段组成
  - 其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络
  - 而另一个字段则是主机号 host-id，它标志该主机 （或路由器）

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/IP%E5%9C%B0%E5%9D%80%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8F%B7%E5%AD%97%E6%AE%B5%E5%92%8C%E4%B8%BB%E6%9C%BA%E5%8F%B7%E5%AD%97%E6%AE%B5.png" alt="IP地址中的网络号字段和主机号字段" width="500" height="300" />

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E5%B8%B8%E7%94%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%88%AB%E7%9A%84IP%E5%9C%B0%E5%9D%80.png" alt="常用的三种类别的IP地址" width="500" height="300" />

##### IP地址的一些重要特点

- IP 地址是一种分等级的地址结构
  - IP地址管理机构在分配 IP地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配
  - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间
- 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口
  - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的
    - 这种主机称为多归属主机 （multihomed host）
  - 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址
- 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id
- 所有分配到网络号 net-id 的网络，范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的

#### IP 地址与硬件地址

- IP层抽象的互联网屏蔽了下层很复杂的细节 
  - 在抽象的网络层上讨论问题，就能够使用 统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/IP%E5%9C%B0%E5%9D%80%E4%B8%8E%E7%A1%AC%E4%BB%B6%E5%9C%B0%E5%9D%80.png" alt="IP地址与硬件地址" width="500" height="300" />

#### 地址解析协议 ARP 和 逆地址解析协议 RARP 

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE%20ARP%20%E5%92%8C%20%E9%80%86%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE%20RARP.png" alt="地址解析协议 ARP 和 逆地址解析协议 RARP" width="500" height="300" />

#### 地址解析协议 ARP

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址
- 每一个主机都设有一个 ARP 高速缓存（ARP cache），里面有所在的局域网上的各主机和路由器 的 IP 地址到硬件地址的映射表
- 当主机 A 欲向本局域网上的某个主机 B 发送 IP 数 据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址
  - 如有，就可查出其对应的硬件地址， 再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址

##### 应当注意的问题

- ARP 是解决同一个局域网上的主机或路由器 的 IP 地址和硬件地址的映射问题
- 如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络
  - 剩下的工作就由下一个网络来做
- 从IP地址到硬件地址的解析是自动进行的， 主机的用户对这种地址解析过程是不知道的
- 只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址

##### ARP 高速缓存的作用

- 为了减少网络上的通信量，主机 A 在发送 其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组
- 当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己 的 ARP 高速缓存中
  - 这对主机 B 以后向 A 发送数据报时就更方便了

#### 逆地址解析协议 RARP 

- 逆地址解析协议 RARP 使只知道自己硬件地址的主机能够知道其 IP 地址
- 这种主机往往是无盘工作站
  - 因此 RARP 协议目前已很少使用

#### IP 数据报的格式

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/IP%20%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E6%A0%BC%E5%BC%8F.png" alt="IP 数据报的格式" width="500" height="300" />

- 版本——占 4 位，指 IP 协议的版本目前的 IP 协议版本号为 4 （即 IPv4）
- 首部长度——占 4 位，可表示的最大数值 是 15 个单位（一个单位为 4 字节） 因此 IP 的首部长度的最大值是 60 字节
- 区分服务——占 8 位，用来获得更好的服务在旧标准中叫做服务类型，但实际上一直未被使用过
  - 1998 年这个字段改名为区分服务
  - 只有在使用区分服务（DiffServ）时，这个字段才起作用
  - 在一般的情况下都不使用这个字段
- 总长度——占 16 位，指首部和数据之和的长度， 单位为字节，因此数据报的最大长度为 65535 字节
  - 总长度必须不超过最大传送单元 MTU
- 标识（identification） 占 16 位， 它是一个计数器，用来产生数据报的标识
- 标志（flag） 占 3 位，目前只有前两位有意义
  - 标志字段的最低位是 MF （More Fragment）
    - MF = 1 表示后面“还有分片”
    - MF = 0 表示最后一个分片
  -  标志字段中间的一位是 DF （Don't Fragment） 
    - 只有当 DF = 0 时才允许分片
- 片偏移（12 位）指出：较长的分组在分片后某片在原分组中的相对位置
  - 片偏移以 8 个字节为偏移单位。
- 生存时间（8 位）记为 TTL （Time To Live） 
  - 数据报在网络中可通过的路由器数的最大值
- 协议（8 位）字段指出此数据报携带的数据使用何种协议：TCP、UDP、ICMP、IGMP、OSPF
  - 以便目的主机的 IP 层将数据部分上交给哪个处理过程
- 首部检验和（16 位）字段只检验数据报的首部，不检验数据部分
  - 这里不采用 CRC 检验码而采用简单的计算方法
- 源地址和目的地址都各占 4 字节

##### IP 数据报首部的可变部分

- IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富
- 选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目
- 增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的
  - 这就增加了每一个路由器处理数据报的开销
- 实际上这些选项很少被使用

#### IP 层转发分组的流程

- 若按目的主机号来制作路由表， 则所得出的路由表就会过于庞大
- 但若按主机所在的网络地址来制作路由表， 那么每一个路由器中的路由表就只包含 4 个项目
  - 这样就可使路由表大大简化
- 在路由表中，对每一条路由，最主要的是 （目的网络地址，下一跳地址）

##### 查找路由表

- 特定主机路由
  - 这种路由是为特定的目的主机指明一个路由
- 默认路由（default route）
  - 路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间
  - 这种转发方式在一个网络只有很少的对外连接时是很有用的
- 默认路由在主机发送 IP 数据报时往往更能显示出它的好处
- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和因特网连接，那么在这种情况下使用默认路由是非常合适的。

##### 必须强调指出

- IP 数据报的首部中没有地方可以用来指明“下 一跳路由器的 IP 地址” 
- 当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件
- 网络接口软件使用 ARP负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器

### 4.3 划分子网和构造超网

- 划分子网纯属一个单位内部的事情
  - 单位对外仍然表现为没有划分子网的网络
- 从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位
- 凡是从其他网络发送给本单位某个主机的 IP 数据报， 仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器
- 然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网
- 最后就将 IP 数据报直接交付目的主机

#### 划分子网后变成了三级结构

- 子网掩码（subnet mask）
- （IP地址） AND （子网掩码） = 网络地址

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/IP%E5%9C%B0%E5%9D%80%E7%9A%84%E5%90%84%E5%AD%97%E6%AE%B5%E5%92%8C%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81.png" alt="IP地址的各字段和子网掩码" width="500" height="300" />

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E9%BB%98%E8%AE%A4%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81.png" alt="默认子网掩码" width="500" height="300" />

##### 子网掩码是一个重要属性

- 子网掩码是一个网络或一个子网的重要属性
- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器
- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码
- 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码

#### 无分类编址 CIDR（[分IP时用CIDR更加方便](https://www.zhihu.com/question/364427671/answer/960814680)）

- CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间
- CIDR 使用各种长度的“网络前缀”（network-prefix）来代替分类地址中的网络号和子网号
- IP 地址从三级编址（使用子网掩码）又回到了两级编址
- CIDR 还使用“斜线记法”（slash notation），它又称为CIDR记法，即在 IP 地址面加上一个斜线“/”， 然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）
- CIDR 把网络前缀都相同的连续的 IP 地址组成 “CIDR 地址块”

##### 路由聚合（route aggregation） 

- 一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由
- 路由聚合也称为构成超网（supernetting）
- CIDR 虽然不使用子网了，但仍然使用“掩码” 这一名词（但不叫子网掩码）
- 对于 /20 地址块，它的掩码是 20个连续的 1
  - 斜线记法中的数字就是掩码中1的个数
- 前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C 类地址
- 这些 C 类地址合起来就构成了超网
- CIDR 地址块中的地址数一定是 2 的整数次幂
- 网络前缀越短，其地址块所包含的地址数就越多
- 而在三级结构的IP地址中， 划分子网是使网络前缀变长

##### CIDR 记法的其他形式

- 128.14.32.0/20
- 10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略
- 网络前缀的后面加一个星号 * 的表示方法如 00001010 00*
  - 在星号 * 之前是网络前缀， 而星号 * 表示 IP 地址中的主机号，可以是任意值

##### 最长前缀匹配

- 使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成
  - 在查找路由表时可能会得到不止一个匹配结果
- 应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配（longest-prefix matching） 
- 网络前缀越长，其地址块就越小，因而路由就越具体（more specific） 
- 最长前缀匹配又称为最长匹配或最佳匹配

##### 使用二叉线索查找路由表

- 当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题
- 为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找
  - 这里最常用的就是二叉线索（binary trie）
- IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址
- 为了提高二叉线索的查找速度，广泛使用了各种压缩技术。

### 4.4 网际控制报文协议 ICMP

- 为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP （Internet Control Message Protocol）
- ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告
- ICMP 不是高层协议，而是 IP 层的协议
- ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去
- ICMP 报文的种类有两种
  - 即 ICMP 差错报告报文
    - 终点不可达 
    - 源点抑制（Source quench） 
    - 时间超过 
    - 参数问题 
    - 改变路由（重定向）（Redirect）
  - ICMP 询问报文
    - 回送请求和回答报文 
    - 时间戳请求和回答报文

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/ICMP%E6%8A%A5%E6%96%87%E7%9A%84%E6%A0%BC%E5%BC%8F.png" alt="ICMP报文的格式" width="500" height="300" />]

#### PING（Packet InterNet Groper） 

- PING 用来测试两个主机之间的连通性
- PING 使用了 ICMP 回送请求与回送回答报文
  - PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP

### 4.5 因特网的路由选择协议

- 静态路由选择策略——即非自适应路由选择， 其特点是简单和开销较小，但不能及时适应网络状态的变化
- 动态路由选择策略——即自适应路由选择， 其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大

#### 自治系统 AS（Autonomous System）

- 自治系统 AS 的定义：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由
- 现在对自治系统 AS 的定义是强调下面的事实： 尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略

##### 因特网有两大类路由选择协议

- 内部网关协议 IGP （Interior Gateway Protocol） 即在一个自治系统内部使用的路由选择协议
  - 在自治系统内部的路由选择叫做域内路由选择（intradomain routing） 
  - 目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议
- 外部网关协议EGP （External Gateway Protocol） 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中
  - 自治系统之间的路由选择也叫做域间路由选择（interdomain routing）
  - 这样的协议就是外部网关协议 EGP
  - 在外部网关协议中目前使用最多的是 BGP-4。

#### 内部网关协议 RIP（Routing Information Protocol）

- 路由信息协议 RIP 是内部网关协议 IGP 中最先得到广泛使用的协议
- RIP 是一种分布式的基于距离向量的路由选择协议
- RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
- 仅和相邻路由器交换信息
- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔交换路由信息，例如， 每隔 30 秒

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/RIP2%E5%8D%8F%E8%AE%AE%E7%9A%84%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.png" alt="RIP2协议的报文格式" width="500" height="300" />

##### “距离”的定义

- 从一路由器到直接连接的网络的距离定义为 1
- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1
- RIP协议中的“距离”也称为“跳数”（hop count），因为每经过一个路由器，跳数就加 1
- 这里的“距离”实际上指的是“最短距离” 
- RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短” 
- RIP 允许一条路径最多只能包含 15 个路由器
- “距离”的最大值为16 时即相当于不可达
  - 可见 RIP 只适用于小型互联网
- RIP 不能在两个网络之间同时使用多条路由。
  - RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速（低时延）但路由器较多的路由

##### 路由表的建立

- 路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）
- 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址
- RIP 协议的收敛（convergence）过程较快，即在自治系统中所有的结点都得到正确的路由选择信息的过程

##### RIP 协议的优缺点

- RIP 存在的一个问题是当网络出现故障时，要 经过比较长的时间才能将此信息传送到所有的路由器
- RIP 协议最大的优点就是实现简单，开销较小
- RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）
- 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加
- 这就是好消息传播得快，而坏消息传播得慢
  - 网络出故障的传播时间往往需要较长的时间（例如数分钟）。这是 RIP 的一个主要缺点

#### 内部网关协议 OSPF （Open Shortest Path First）

- “开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的
- “最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法SPF
- OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”
- 是分布式的链路状态协议

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/OSPF%E5%88%86%E7%BB%84.png" alt="OSPF分组" width="500" height="300" />

##### 三个要点

- 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法
- 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息
- “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”（metric）
- 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息

##### 划分区域

- 在上层的区域叫作主干区域（backbone area）
- 主干区域的标识符规定为0.0.0.0
- 主干区域的作用是用来连通其他在下层的区域

##### OSPF 直接用 IP 数据报传送

- OSPF 不用 UDP 而是直接用 IP 数据报传送
- OSPF 构成的数据报很短
- 这样做可减少路由信息的通信量
- 数据报很短的另一好处是可以不必将长的数据报分片传送
  - 分片传送的数据报只要丢失一个， 就无法组装成原来的数据报，而整个数据报就必须重传

##### OSPF 的五种分组类型

- 类型1，问候（Hello）分组
- 类型2，数据库描述（Database Description）分组
- 类型3，链路状态请求（Link State Request）分组
- 类型4，链路状态更新（Link State Update）分组， 用洪泛法对全网更新链路状态
- 类型5，链路状态确认（Link State Acknowledgment） 分组。

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/OSPF%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.png" alt="OSPF的基本操作" width="500" height="300" />

##### OSPF 的其他特点

- OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态
- 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系
  - 因此当互联网规模很大时， OSPF 协议要比距离向量协议 RIP 好得多
- OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms

#### 外部网关协议 BGP

- BGP 是不同自治系统的路由器之间交换路由信息的协议
- 边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/BGP%E6%8A%A5%E6%96%87%E5%85%B7%E6%9C%89%E9%80%9A%E7%94%A8%E7%9A%84%E9%A6%96%E9%83%A8.png" alt="BGP报文具有通用的首部" width="500" height="300" />

##### BGP 发言人 （BGP speaker）

- 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人”
- 一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器
- 一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接， 然后在此连接上交换 BGP 报文以建立 BGP 会话（session），利用 BGP 会话交换路由信息
- 使用 TCP 连接能提供可靠的服务，也简化了路由选择协议
- 使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站或对等站

##### BGP 协议的特点

- BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多
- 每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂
- BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列
- 在BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表
  - 但以后只需要在发生变化时更新有变化的部分
    - 这样做对节省网络带宽和减少路由器的处理开销方面都有好处

##### BGP-4 共使用四种报文

- 打开（OPEN）报文，用来与相邻的另一个BGP 发言人建立关系
- 更新（UPDATE）报文，用来发送某一路由的信息，以及列出要撤消的多条路由
- 保活（KEEPALIVE）报文，用来确认打开报文和周期性地证实邻站关系
- 通知（NOTIFICATION）报文，用来发送检测到的差错

#### 路由器在网际互连中的作用

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E5%85%B8%E5%9E%8B%E7%9A%84%E8%B7%AF%E7%94%B1%E5%99%A8%E7%9A%84%E7%BB%93%E6%9E%84.png" alt="典型的路由器的结构" width="500" height="300" />

##### “转发”和“路由选择”的 区别

- “转发”（forwarding）就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去
- “路由选择”（routing）则是按照分布式算法， 根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由
- 路由表是根据路由选择算法得出的
  - 而转发表是从路由表得出的

##### 输入端口对线路上收到的分组的处理

- 数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理
  - 这会产生一定的时延

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E8%BE%93%E5%85%A5%E7%AB%AF%E5%8F%A3%E5%AF%B9%E7%BA%BF%E8%B7%AF%E4%B8%8A%E6%94%B6%E5%88%B0%E7%9A%84%E5%88%86%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86.png" alt="输入端口对线路上收到的分组的处理" width="500" height="300" />

##### 分组丢弃

- 若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃
- 路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因

### 4.6 IP 多播

- 多播可明显地减少网络中资源的消耗

#### IP 多播的一些特点

- 多播使用组地址—— IP 使用 D 类地址支持多播
  - 多播地址只能用于目的地址， 而不能用于源地址
- 永久组地址——由因特网号码指派管理局 IANA 负责指派
- 动态的组成员 
- 使用硬件进行多播

#### 网际组管理协议 IGMP 和多播路由选择协议

- 为了使路由器知道多播组成员的信息， 需要利用网际组管理协议 IGMP （Internet Group Management Protocol）
  - IGMP 并非在因特网范围内对所有多播组成员进行管理的协议
  - IGMP 不知道 IP 多播组包含的成员数， 也不知道这些成员都分布在哪些网络上
  - IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机 （严格讲，是主机上的某个进程）参加或退出了某个多播组
- 连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作， 以便把多播数据报用最小代价传送给所有的组成员
  - 这就需要使用多播路由选择协议
    - 多播路由选择协议尚未标准化

##### 网际组管理协议 IGMP

- 和 ICMP 相似，IGMP 使用 IP 数据报传递其报文（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务
- 因此，我们不把 IGMP 看成是一个单独的协议，而是属于整个网际协议 IP 的一个组成部分

##### 转发多播数据报使用的方法：洪泛与剪除

- 这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相邻接的
- 一开始，路由器转发多播数据报使用洪泛的方法（这就是广播）
  - 为了避免兜圈子，采用了叫做反向路径广播 RPB (Reverse Path Broadcasting)的策略
    - 路由器收到多播数据报时，先检查是否从源点经最短路径传送来的
    - 若是，就向所有其他方向转发刚才收到的多播数据报（但进入的方向除外），否则就丢弃而不转发
    - 如果存在几条同样长度的最短路径），那么只能选择一条最短路径，选择的准则就是看这几条最短路径中的相邻路由器谁的 IP 地址最小

##### 隧道技术(tunneling)

暂无内容。

##### 基于核心的发现技术

- 这种方法对于多播组的大小在较大范围内变化时都适合
- 这种方法是对每一个多播组 G 指定一个核心(core)路由器，给出它的 IP 单播地址
- 核心路由器按照前面讲过的方法创建出对应于多播组 G 的转发树

### 4.7 虚拟专用网 VPN 和网络地址转换 NAT

#### 虚拟专用网 VPN

- 本地地址——仅在机构内部使用的 IP 地 址，可以由本机构自行分配，而不需要向因特网的管理机构申请
  - 10.0.0.0 到 10.255.255.255 
  - 172.16.0.0 到 172.31.255.255 
  - 192.168.0.0 到 192.168.255.255 
  - 这些地址只能用于一个机构的内部通信，而不能用于和因特网上的主机通信
  - 专用地址只能用作本地地址而不能用作全球地址
    - 在因特网中的所有路由器对目的地址是专用地址的数据报一律不进行转发
- 全球地址——全球唯一的IP地址，必须向因特网的管理机构申请
  - 用隧道技术实现虚拟专用网

#### 内联网 intranet 和外联网 extranet （都是基于 TCP/IP 协议）

- 由部门 A 和 B 的内部网络所构成的虚拟专用网 VPN 又称为内联网(intranet)，表示部门 A 和 B 都是在同一个机构的内部
- 一个机构和某些外部机构共同建立的虚拟专用网 VPN 又称为外联网(extranet)

#### 远程接入VPN (remote access VPN)

- 有的公司可能没有分布在不同场所的部门，但有很多流动员工在外地工作
  - 公司需要和他们保持联系，远程接入 VPN 可满足这种需求
- 在外地工作的员工拨号接入因特网，而驻留在员工 PC 机中的 VPN 软件可在员工的 PC 机 和公司的主机之间建立 VPN 隧道，因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络

#### 网络地址转换 NAT (Network Address Translation)

- 需要在专用网连接到因特网的路由器上安装 NAT 软件
  - 装有 NAT 软件的路由器叫做 NAT 路由器，它至少有一个有效的外部全球地址 IPG
- 所有使用本地地址的主机在和外界通信时都要在 NAT 路由器上将其本地地址转换成 IPG 才能和因特网连接
- 内部主机 X 用本地地址 IPX 和因特网上主机 Y 通信所发送的数据报必须经过 NAT 路由器
- NAT 路由器将数据报的源地址 IPX 转换成全球地址 IPG，但目的地址 IPY 保持不变，然后发送到因特网
- NAT 路由器收到主机 Y 发回的数据报时，知道数据报中的源地址是 IPY 而目的地址是 IPG
- 根据 NAT 转换表，NAT 路由器将目的地址 IPG 转换为 IPX，转发给最终的内部主机 X

## 第 5 章 运输层

### 5.1 运输层协议概述

- 从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层
- 当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，只有位于网络边缘部分的主机的协议栈才有运输层，而网络核心部分中的路由器在转发分组时都只用到下三层的功能

#### 应用进程之间的通信

- 两个主机进行通信实际上就是两个主机中的应用进程互相通信
- 应用进程之间的通信又称为端到端的通信
- 运输层的一个很重要的功能就是复用和分用
  - 应用层不同进程的报文通过不同的端口向下交到运输层，再往下就共用网络层提供的服务
- “运输层提供应用进程间的逻辑通信” 
  - “逻辑通信”的意思是：运输层之间的通信好像是沿水平方向传送数据
  - 但事实上这两个运输层之间并没有一条水平方向的物理连接

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E8%BF%90%E8%BE%93%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%92%8C%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8C%BA%E5%88%AB.png" alt="运输层协议和网络层协议的主要区别" width="500" height="300" />

#### 两种不同的运输协议

- 运输层向高层用户屏蔽了下面网络核心的细节 （如网络拓扑、所采用的路由选择协议等）， 它使应用进程看见的就是好像在两个运输层实体之间有一条端到端的逻辑通信信道
- 当运输层采用面向连接的 TCP 协议时，尽管下面的网络是不可靠的（只提供尽最大努力服 务），但这种逻辑通信信道就相当于一条全双工的可靠信道
- 当运输层采用无连接的 UDP 协议时，这种逻辑通信信道是一条不可靠信道

#### 运输层的两个主要协议运输层的两个主要协议

TCP/IP 的运输层有两个不同的协议： 

- 用户数据报协议 UDP (User Datagram Protocol) 
- 传输控制协议 TCP (Transmission Control Protocol)

#### TCP与UDP

- 两个对等运输实体在通信时传送的数据单位叫作运输协议数据单元 TPDU (Transport Protocol Data Unit)
- TCP 传送的数据单位协议是 TCP 报文段 (segment) 
  - TCP 则提供面向连接的服务
    - TCP 不提供广 播或多播服务
    - 由于 TCP 要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销
    - 这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源
- UDP 传送的数据单位协议是 UDP 报文或用户数据报
  - UDP 在传送数据之前不需要先建立连接
    - 对 方的运输层在收到 UDP 报文后，不需要给出任何确认
    - 虽然 UDP 不提供可靠交付，但在某些情况下 UDP 是一种最有效的工作方式

##### 还要强调两点

- 运输层的 UDP用户数据报与网际层的IP数据报有很大区别
  - IP数据报要经过互连网中许多路由器的存储转发，但UDP用户数据报是在运输层的端到端抽象的逻辑信道中传送的
- TCP 报文段是在运输层抽象的端到端逻辑信道中传送，这种信道是可靠的全双工信道
  - 但这样的信道却不知道究竟经过了哪些路由器，而这些路由器也根本不知道上面的运输层是否建立了 TCP 连接

#### 端口号(protocol port number) 简称为端口(port)

- 解决这个问题的方法就是在运输层使用协议端口号(protocol port number)，或通常简称为端口(port)
- 虽然通信的终点是应用进程，但我们可以把端口想象是通信的终点，因为我们只要把要传送的报文交到目的主机的某一个合适的目的端口， 剩下的工作（即最后交付目的进程）就由 TCP 来完成

##### 软件端口与硬件端口

- 在协议栈层间的抽象的协议端口是软件端口
- 路由器或交换机上的端口是硬件端口
- 硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址

##### TCP 的端口

- 端口用一个 16 位端口号进行标志
- 端口号只具有本地意义，即端口号只是为了标志本计算机应用层中的各进程
  - 在因特网中不同计算机的相同端口号是没有联系的

##### 三类端口

- 熟知端口，数值一般为 0~1023
- 登记端口号，数值为1024~49151，为没有熟知端口号的应用程序使用的
  - 使用这个范围的端口号必须在 IANA 登记，以防止重复
- 客户端口号或短暂端口号，数值为 49152~65535，留给客户进程选择暂时使用
  - 当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号
  - 通信结束后， 这个端口号可供其他客户进程以后使用。

### 5.2 用户数据报协议 UDP 

- UDP 只在 IP 的数据报服务之上增加了很少一点的功能，即端口的功能和差错检测的功能
- 虽然 UDP 用户数据报只能提供不可靠的交付，但 UDP 在某些方面有其特殊的优点
- UDP 是无连接的，即发送数据之前不需要建立连接
- UDP 使用尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制
- UDP 是面向报文的
  - UDP 没有拥塞控制，很适合多媒体通信的要求
- UDP 支持一对一、一对多、多对一和多对多的交互通信
- UDP 的首部开销小，只有 8 个字节

#### 面向报文的 UDP

- 发送方 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层
  - UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界
- 应用层交给 UDP 多长的报文，UDP 就照样发送，即一次发送一个报文
- 接收方 UDP 对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程，一次交付一个完整的报文
- 应用程序必须选择合适大小的报文

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/UDP%E6%98%AF%E9%9D%A2%E5%90%91%E6%8A%A5%E6%96%87%E7%9A%84.png" alt="UDP是面向报文的" width="500" height="300" />

#### UDP 的首部格式

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/UDP%E7%9A%84%E9%A6%96%E9%83%A8%E6%A0%BC%E5%BC%8F.png" alt="UDP的首部格式" width="500" height="300" />

### 5.3 传输控制协议 TCP 概述

- TCP 是面向连接的运输层协议
- 每一条 TCP 连接只能有两个端点 (endpoint)，每一条 TCP 连接只能是点对点的（一对一）
- TCP 提供可靠交付的服务
- TCP 提供全双工通信
- 面向字节流

##### 应当注意

- TCP 连接是一条虚连接而不是一条真正的物理连接
- TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是不关心的
- TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）
- TCP 可把太长的数据块划分短一些再传送
  - TCP 也可等待积累有足够多的字节后再构成报文段发送出去

#### TCP 的连接

- TCP 把连接作为最基本的抽象
- 每一条 TCP 连接有两个端点
- TCP 连接的端点不是主机，不是主机的 IP 地址，不是应用进程，也不是运输层的协议端口
  - TCP 连接的端点叫做套接字(socket)或插口
- 端口号拼接到(contatenated with) IP 地址即构成了套接字

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E5%A5%97%E6%8E%A5%E5%AD%97.png" alt="套接字" width="500" height="300" />

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/TCP%E8%BF%9E%E6%8E%A5.png" alt="TCP连接" width="500" height="300" />

### 5.4 可靠传输的工作原理

#### 停止等待协议

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E5%81%9C%E6%AD%A2%E7%AD%89%E5%BE%85%E5%8D%8F%E8%AE%AE.png" alt="停止等待协议" width="500" height="300" />

##### 请注意

- 在发送完一个分组后，必须暂时保留已发送的分组的副本
- 分组和确认分组都必须进行编号
- 超时计时器的重传时间应当比数据在分组传输的平均往返时间更长一些

##### 确认丢失和确认迟到

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E7%A1%AE%E8%AE%A4%E4%B8%A2%E5%A4%B1%E5%92%8C%E7%A1%AE%E8%AE%A4%E8%BF%9F%E5%88%B0.png" alt="确认丢失和确认迟到" width="500" height="300" />

#### 可靠通信的实现

- 使用上述的确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信
- 这种可靠传输协议常称为自动重传请求 ARQ (Automatic Repeat reQuest)。
- ARQ 表明重传的请求是自动进行的
  - 接收方不需要请求发送方重传某个出错的分组 

#### 信道利用率

- 停止等待协议的优点是简单，但缺点是信道利用率太低

$$
U = \frac{T_D}{T_D + RTT + T_A}
$$



<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E4%BF%A1%E9%81%93%E5%88%A9%E7%94%A8%E7%8E%87.png" alt="信道利用率" width="500" height="300" />

#### 流水线传输

- 发送方可连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认
- 由于信道上一直有数据不间断地传送，这种传输方式可获得很高的信道利用率

#### 连续 ARQ 协议

- 发送方维持发送窗口
- 收到一个确认后发送窗口向前滑动

##### 累积确认

- 接收方一般采用累积确认的方式
  - 即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了
- 累积确认有的优点是：容易实现，即使确认丢失也不必重传
  - 缺点是：不能向发送方反映出接收方已经正确收到的所有分组的信息

##### Go-back-N（回退 N）

- 如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了
  - 这时接收方只能对前两个分组发出确认
  - 发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次
- 这就叫做 Go-back-N（回退 N），表示需要再退回来重传已发送过的 N 个分组
- 可见当通信线路质量不好时，连续 ARQ 协议会带来负面的影响

#### TCP 可靠通信的具体实现

- TCP 连接的每一端都必须设有两个窗口——一个发送窗口和一个接收窗口
- TCP 的可靠传输机制用字节的序号进行控制
  - TCP 所有的确认都是基于序号而不是基于报文段
- TCP 两端的四个窗口经常处于动态变化之中
- TCP连接的往返时间 RTT 也不是固定不变的
  - 需要使用特定的算法估算较为合理的重传时间

### 5.5 TCP 报文段的首部格式

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\TCP报文段的首部格式.png" alt="TCP报文段的首部格式" width="500" height="300" />

- 源端口和目的端口字段——各占 2 字节
  - 端口是运输层与应用层的服务接口
  - 运输层的复用和分用功能都要通过端口才能实现
- 序号字段——占 4 字节
  - TCP 连接中传送的数据流中的每一个字节都编上一个序号
  - 序号字段的值则指的是本报文段所发送的数据的第一个字节的序号
- 确认号字段——占 4 字节
  - 是期望收到对方的下一个报文段的数据的第一个字节的序号
- 数据偏移（即首部长度）——占 4 位
  - 它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远
  - “数据偏移”的单位是 32 位字（以 4 字节为计算单位）
- 保留字段——占 6 位
  - 保留为今后使用，但目前应置为 0
- 紧急 URG 
  - 当 URG = 1 时表明紧急指针字段有效
  - 它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)
- 确认 ACK 
  - 只有当 ACK = 1 时确认号字段才有效
  - 当 ACK = 0 时，确认号无效
- 推送 PSH (PuSH) 
  - 接收 TCP 收到 PSH = 1 的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付
- 复位 RST (ReSeT) 
  - 当 RST = 1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接
- 同步 SYN 
  - 同步 SYN = 1 表示这是一个连接请求或连接接受报文
- 终止 FIN (FINis) 
  - 用来释放一个连接
  - FIN = 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接
- 窗口字段 —— 占 2 字节
  - 用来让对方设置发送窗口的依据，单位为字节
- 检验和 —— 占 2 字节
  - 检验和字段检验的范围包括首部和数据这两部分
  - 在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部
- 紧急指针字段 —— 占 16 位
  - 指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）
- 选项字段 —— 长度可变
  - TCP 最初只规定了一种选项，即最大报文段长度 MSS
  - MSS 告诉对方 TCP： “我的缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节
    - MSS (Maximum Segment Size) 是 TCP 报文段中的数据字段的最大长度
    - 数据字段加上 TCP 首部才等于整个的 TCP 报文段
- 其他选项
  - 窗口扩大选项 ——占 3 字节
    - 其中有一个字节表示移位值 S
    - 新的窗口值等于TCP 首部中的窗口位数增大到(16 + S)，相当于把窗口值向左移动 S 位后获得实际的窗口大小
  - 时间戳选项——占10 字节
    - 其中最主要的字段时间戳值字段（4 字节）和时间戳回送回答字段（4 字节）
  - 选择确认选项
    - 在后面的 5.6.3 节介绍
- 填充字段 
  - 这是为了使整个首部长度是 4 字节的整数倍

### 5.6 TCP 可靠传输的实现

#### 以字节为单位的滑动窗口

- 根据 B 给出的窗口值 A 构造出自己的发送窗口
- A 发送了 11 个字节的数据
  - P3 – P1 = A 的发送窗口（又称为通知窗口） 
  - P2 – P1 = 已发送但尚未收到确认的字节数 
  - P3 – P2 = 允许发送但尚未发送的字节数（又称为可用窗口）
- A 收到新的确认号，发送窗口向前滑动
- A 的发送窗口内的序号都已用完， 但还没有再收到确认，必须停止发送

#### 发送缓存与接收缓存的作用

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\发送缓存.png" alt="发送缓存" width="500" height="300" />

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\接收缓存.png" alt="接收缓存" width="500" height="300" />

- 发送缓存用来暂时存放： 
  - 发送应用程序传送给发送方 TCP 准备发送的数据；
  - TCP 已发送出但尚未收到确认的数据
- 接收缓存用来暂时存放： 
  - 按序到达的、但尚未被接收应用程序读取的数据
  - 不按序到达的数据

##### 需要强调三点

- A 的发送窗口并不总是和 B 的接收窗口一样大 （因为有一定的时间滞后）
- TCP 标准没有规定对不按序到达的数据应如何处理
  - 通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程
- TCP 要求接收方必须有累积确认的功能，这样可以减小传输开销

#### 超时重传时间的选择

- 重传机制是 TCP 中最重要和最复杂的问题之一
- TCP 每发送一个报文段，就对这个报文段设置一次计时器
  - 只要计时器设置的重传时间到但还没有收到确认，就要重传这一报文段

##### 加权平均往返时间

- TCP 保留了 RTT 的一个加权平均往返时间 RTTS（这 又称为平滑的往返时间）
- 第一次测量到 RTT 样本时，RTTS 值就取为所测量到 的 RTT 样本值
  - 以后每测量到一个新的 RTT 样本， 就按下式重新计算一次 RTTS：

$$
RTT_S = (1 - \alpha) * (旧的RTT_S) + \alpha * (新的RTT样本)
$$

- 式中，0 ≤ α ≤ 1。若 α 很接近于零，表示 RTT 值更新 较慢。若选择 α 接近于 1，则表示 RTT 值更新较快
- RFC 2988 推荐的 α 值为 1/8，即 0.125

##### 超时重传时间 RTO (RetransmissionTime-Out)

- RTO 应略大于上面得出的加权平均往返时间 RTTS
- RFC 2988 建议使用下式计算 RTO：

$$
RTO = RTT_S + 4 * RTT_D
$$



- RTTD 是 RTT 的偏差的加权平均值
- RFC 2988 建议这样计算 RTTD
  - 第一次测量时， RTTD 值取为测量到的 RTT 样本值的一半
  - 在以后的 测量中，则使用下式计算加权平均的 RTTD：

$$
新的RTT_D = (1 - \beta) * (旧的RTT_D) + \beta * |RTT_S - 新的RTT样本|
$$

- β 是个小于 1 的系数，其推荐值是 1/4，即 0.25

##### 往返时间的测量相当复杂

- TCP 报文段 1 没有收到确认
  - 重传（即报文段 2）后，收到了确认报文段 ACK
- 如何判定此确认报文段是对原来的报文段 1 的 确认，还是对重传的报文段 2 的确认

##### Karn 算法

- 在计算平均往返时间 RTT 时，只要报文段重传了，就不采用其往返时间样本
- 这样得出的加权平均平均往返时间 RTTS 和超时重传时间 RTO 就较准确

##### 修正的 Karn 算法

- 报文段每重传一次，就把 RTO 增大一些： 

$$
新的RTO = \gamma * (旧的RTO)
$$



-  系数 γ 的典型值是 2 
- 当不再发生报文段的重传时，才根据报文段的往返时延更新平均往返时延 RTT 和超时重传时间 RTO 的数值
- 实践证明，这种策略较为合理

#### 选择确认 SACK(Selective ACK)

- 接收方收到了和前面的字节流不连续的两个字节块
- 如果这些字节的序号都在接收窗口之内， 那么接收方就先收下这些数据，但要把这些信息准确地告诉发送方，使发送方不要再重复发送这些已收到的数据
- 如果要使用选择确认，那么在建立 TCP 连接时，就要在 TCP 首部的选项中加上“允许 SACK”的选项，而 双方必须都事先商定好
- 如果使用选择确认，那么原来首部中的“确认号字段” 的用法仍然不变
  - 只是以后在 TCP 报文段的首部中都增加了 SACK 选项，以便报告收到的不连续的字节块的边界
- 由于首部选项的长度最多只有 40 字节，而指明一个边界就要用掉 4 字节，因此在选项中最多只能指明 4 个字节块的边界信息。

### 5.7 TCP的流量控制

#### 利用滑动窗口实现流量控制

- 一般说来，我们总是希望数据传输得更快一些
  - 但如果发送方把数据发送得过快，接收方就可能来不及接收，这就会造成数据的丢失
- 流量控制(flow control)就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞
- 利用滑动窗口机制可以很方便地在 TCP 连接上实现流量控制

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\流量控制举例.png" alt="流量控制举例" width="500" height="300" />

#### 持续计时器 (persistence timer)

- TCP 为每一个连接设有一个持续计时器
- 只要 TCP 连接的一方收到对方的零窗口通知， 就启动持续计时器
- 若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带 1 字节的数据），而对方就在确认这个探测报文段时给出了现在的窗口值
- 若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器
- 若窗口不是零，则死锁的僵局就可以打破了

#### 必须考虑传输效率

- 可以用不同的机制来控制 TCP 报文段的发送时机: 
- 第一种机制是 TCP 维持一个变量，它等于最大报文段长度 MSS
- 只要缓存中存放的数据 达到 MSS 字节时，就组装成一个 TCP 报文段发送出去
- 第二种机制是由发送方的应用进程指明要求发送报文段，即 TCP 支持的推送(push)操作
- 第三种机制是发送方的一个计时器期限到了， 这时就把当前已有的缓存数据装入报文段（但长度不能超过 MSS）发送出去

### 5.8 TCP 的拥塞控制

- 在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏——产生拥塞(congestion) 
- 出现资源拥塞的条件： 对资源需求的总和 > 可用资源 
- 若网络中有许多资源同时产生拥塞，网络的性能就要明显变坏，整个网络的吞吐量将随输入负荷的增大而下降

#### 拥塞控制与流量控制的关系

- 拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷
- 拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素
- 流量控制往往指在给定的发送端和接收端之间的点对点通信量的控制
- 流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收

#### 拥塞控制的一般原理

- 拥塞控制是很难设计的，因为它是一个动态的（而不是静态的）问题
- 当前网络正朝着高速化的方向发展，这很容易出现缓存不够大而造成分组的丢失
  - 但分组的丢失是网络发生拥塞的征兆而不是原因
- 在许多情况下，甚至正是拥塞控制本身成为引起网络性能恶化甚至发生死锁的原因

#### 开环控制和闭环控制

- 开环控制方法就是在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在 工作时不产生拥塞
- 闭环控制是基于反馈环路的概念
  - 属于闭环控制的有以下几种措施： 
    - 监测网络系统以便检测到拥塞在何时、何处发生
    - 将拥塞发生的信息传送到可采取行动的地方
    - 调整网络系统的运行以解决出现的问题‘

#### 慢开始和拥塞避免

- 发送方维持一个叫做拥塞窗口 cwnd (congestion window)的状态变量
  - 拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化
  - 发送方让自己的发送窗口等于拥塞窗口
  - 如再考虑到接收方的接收能力，则发送窗口还可能小于拥塞窗口
- 发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去
  - 但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数
- 在主机刚刚开始发送报文段时可先设置拥塞窗口 cwnd = 1，即设置为一个最大报文段 MSS 的数值
- 在每收到一个对新的报文段的确认后，将拥塞窗口加 1，即增加一个 MSS 的数值
- 用这样的方法逐步增大发送端的拥塞窗口 cwnd，可以使分组注入到网络的速率更加合理

##### 传输轮次 (transmission round)

- 使用慢开始算法后，每经过一个传输轮次，拥塞窗口 cwnd 就加倍
- 一个传输轮次所经历的时间其实就是往返时间 RTT
- “传输轮次”更加强调：把拥塞窗口 cwnd 所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认
- 例如，拥塞窗口 cwnd = 4，这时的往返时间 RTT 就是发送方连续发送 4 个报文段，并收到这 4 个报文段的确认，总共经历的时间

##### 设置慢开始门限状态变量 ssthresh

- 慢开始门限 ssthresh 的用法如下： 
  - 当 cwnd < ssthresh 时，使用慢开始算法
  - 当 cwnd > ssthresh 时，停止使用慢开始算法而改用拥塞避免算法
  - 当 cwnd = ssthresh 时，既可使用慢开始算法，也可使用拥塞避免算法
- 拥塞避免算法的思路是让拥塞窗口 cwnd 缓慢地增大， 即每经过一个往返时间 RTT 就把发送方的拥塞窗口 cwnd 加 1，而不是加倍，使拥塞窗口 cwnd 按线性规律缓慢增长

##### 当网络出现拥塞时

- 无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有按时收到确认），就要把慢开始门限 ssthresh 设置为出现拥塞时的发送方窗口值的一半（**但不能小于2**）
- 然后把拥塞窗口 cwnd 重新设置为 1，执行慢开始算法
- 这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕

##### 慢开始和拥塞避免算法的实现举例

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\慢开始和拥塞避免算法的实现举例.png" alt="慢开始和拥塞避免算法的实现举例" width="500" height="300" />

- 当 TCP 连接进行初始化时，将拥塞窗口置为 1
  - 图中的窗口单位不使用字节而使用报文段
- 慢开始门限的初始值设置为 16 个报文段， 即 ssthresh = 16
- 发送端的发送窗口不能超过拥塞窗口 cwnd 和接收端窗口 rwnd 中的最小值
  - 我们假定接收端窗口足够大，因此现在发送窗口的数值等于拥塞窗口的数值
- 在执行慢开始算法时，拥塞窗口 cwnd 的初始值为 1，发送第一个报文段 M0
- 发送端每收到一个确认 ，就把 cwnd 加 1
  - 于是发送端可以接着发送 M1 和 M2 两个报文段
- 接收端共发回两个确认。发送端每收到一个对新报文段的确认，就把发送端的 cwnd 加 1
  - 现在 cwnd 从 2 增大到 4，并可接着发送后面的 4 个报文段
- 发送端每收到一个对新报文段的确认，就把发送端的拥塞窗口加 1，因此拥塞窗口 cwnd 随着传输轮次按指数规律增长
- 当拥塞窗口 cwnd 增长到慢开始门限值 ssthresh 时（即当 cwnd = 16 时），就改为执行拥塞避免算法，拥塞窗口按线性规律增长
- 假定拥塞窗口的数值增长到 24 时，网络出现超时，表明网络拥塞了
- 更新后的 ssthresh 值变为 12（即发送窗口数值 24 的一半），拥塞窗口再重新设置 为 1，并执行慢开始算法
- 当 cwnd = 12 时改为执行拥塞避免算法，拥塞窗口按按线性规律增长，每经过一个往返时延就增加一个 MSS 的大小

##### 乘法减小 (multiplicative decrease)

- “乘法减小“是指不论在慢开始阶段还是拥塞避免阶段，只要出现一次超时（即出现一次网络拥塞） ， 就把慢 开始门限值 ssthresh 设置为当前的拥塞窗口值乘以 0.5
- 当网络频繁出现拥塞时，ssthresh 值就下降得很快，以大大减少注入到网络中的分组数

##### 加法增大 (additive increase)

- “加法增大”是指执行拥塞避免算法后，在收到对所有报文段的确认后（即经过一个往返时间），就把拥塞窗口 cwnd增加一个 MSS 大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞

##### 必须强调指出

- “拥塞避免”并非指完全能够避免了拥塞
  - 利用以上的措施要完全避免网络拥塞还是不可能的
- “拥塞避免”是说在拥塞避免阶段把拥塞窗口控制为按线性规律增长， 使网络比较不容易出现拥塞

#### 快重传和快恢复

- 快重传算法首先要求接收方每收到一个失序的报文段后就立即发出重复确认
  - 这样做可以让发送方及早知道有报文段没有到达接收方
- 发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段
- 不难看出，快重传并非取消重传计时器，而是在 某些情况下可更早地重传丢失的报文段

##### 快恢复算法

- 当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，把慢开始门限 ssthresh 减半
  - 但接下去不执行慢开始算法
- 由于发送方现在认为网络很可能没有发生拥塞， 因此现在不执行慢开始算法，即拥塞窗口 cwnd 现在不设置为 1，而是设置为慢开始门 限 ssthresh 减半后的数值，然后开始执行拥塞避免算法（“加法增大”），使拥塞窗口缓慢地线性增大

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\从连续收到三个重复的确认转入拥塞避免.png" alt="从连续收到三个重复的确认转入拥塞避免" width="500" height="300" />

#### 发送窗口的上限值

- 发送方的发送窗口的上限值应当取为接收方窗口 rwnd 和拥塞窗口 cwnd 这两个变量中较小的一个， 即应按以下公式确定： 

$$
发送窗口的上限值 = Min[rwnd, cwnd]
$$

- 当 rwnd < cwnd 时，是接收方的接收能力限制发送窗口的最大值
- 当 cwnd < rwnd 时，则是网络的拥塞限制发送窗口 的最大值

### 5.9 TCP 的运输连接管理

#### 运输连接的三个阶段

- 运输连接就有三个阶段，即：连接建立、 数据传送和连接释放
  - 运输连接的管理就是使运输连接的建立和释放都能正常地进行
- 连接建立过程中要解决以下三个问题： 
  - 要使每一方能够确知对方的存在
  - 要允许双方协商一些参数（如最大报文段长度，最大窗口大小，服务质量等）
  - 能够对运输实体资源（如缓存大小，连接表中的项目等）进行分配

##### 客户服务器方式

- TCP 连接的建立都是采用客户服务器方式
  - 主动发起连接建立的应用进程叫做客户 (client)
  - 被动等待连接建立的应用进程叫做服务器(server)

##### TCP 的连接建立

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\TCP的连接建立.png" alt="TCP的连接建立" width="500" height="300" />

##### TCP的连接释放

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\TCP的连接释放.png" alt="TCP的连接释放" width="500" height="300" />

- A 必须等待 2MSL 的时间
  - 第一，为了保证 A 发送的最后一个 ACK 报文段能够到达 B
  - 第二，防止 “已失效的连接请求报文段”出现在本连接中
    - A 在发送完最后一个 ACK 报文段后，再经过时间 2MSL，就可以使本连接持续的时间内所产生的所有报文段，都从网络中消失
    - 这样就可以使下一个新的连接中不会出 这种旧的连接请求报文段

## 第 6 章 应用层

### 6.1 域名系统 DNS

#### 域名系统的概述

- 许多应用层软件经常直接使用域名系统 DNS (Domain Name System)，但计算机的用户只是间接而不是直接使用域名系统
- 因特网采用层次结构的命名树作为主机的名字， 并使用分布式的域名系统 DNS
- 名字到 IP 地址的解析是由若干个域名服务器程序完成的
  - 域名服务器程序在专设的结点上运行，运行该程序的机器称为域名服务器

#### 因特网的域名结构

- 因特网采用了层次树状结构的命名方法
- 任何一个连接在因特网上的主机或路由器，都有一个唯一的层次结构的名字，即域名
- 域名的结构由标号序列组成，各标号之间用点隔开： 
  - … . 三级域名 . 二级域名 . 顶级域名
- 各标号分别代表不同级别的域名

#### 域名只是个逻辑概念

- 域名只是个逻辑概念，并不代表计算机所在的 物理地点
- 变长的域名和使用有助记忆的字符串，是为了便于人来使用
  - 而 IP 地址是定长的 32 位二进制数字则非常便于机器进行处理
- 域名中的“点”和点分十进制 IP 地址中的 “点”并无一一对应的关系
  - 点分十进制 IP 地址中一定是包含三个“点”，但每一个域名中“点”的数目则不一定正好是三个

#### 因特网的域名空间

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\因特网的域名空间.png" alt="因特网的域名空间" width="500" height="300" />

#### 域名服务器有以下四种类型

- 根域名服务器 
  - 根域名服务器是最重要的域名服务器
    - 所有的根域名服务器都知道所有的顶级域名服务器的域名和 IP 地址
  - 不管是哪一个本地域名服务器，若要对因特网上任何一个域名进行解析，只要自己无法解析， 就首先求助于根域名服务器
  - 在因特网上共有13 个不同 IP 地址的根域名服务器，它们的名字是用一个英文字母命名，从 a 一直到 m（前13 个字母）
- 顶级域名服务器 
  - 这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名
  - 当收到 DNS 查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步应当找的域名服务器的 IP 地址）
- 权限域名服务器 
  - 这就是前面已经讲过的负责一个区的域名服务器
  - 当一个权限域名服务器还不能给出最后的查询回答时，就会告诉发出查询请求的 DNS 客户，下一步应当找哪一个权限域名服务器
- 本地域名服务器
  - 本地域名服务器对域名系统非常重要
  - 当一个主机发出 DNS 查询请求时，这个 查询请求报文就发送给本地域名服务器
  - 每一个因特网服务提供者 ISP，或一个大学，甚至一个大学里的系，都可以拥有一个本地域名服务器
  - 这种域名服务器有时也称为默认域名服务器

##### 区的不同划分方法举例

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\区的不同划分方法举例.png" alt="区的不同划分方法举例" width="500" height="300" />

#### 提高域名服务器的可靠性

- DNS 域名服务器都把数据复制到几个域名服务器来保存，其中的一个是主域名服务器，其他的是辅助域名服务器
- 当主域名服务器出故障时，辅助域名服务器可以保证 DNS 的查询工作不会中断
- 主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行
  - 这样就保证了数据的一致性

#### 域名的解析过程

- 主机向本地域名服务器的查询一般都是采用递归查询
  - 如果主机所询问的本地域名服务器不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户的身 份，向其他根域名服务器继续发出查询请求报文
- 本地域名服务器向根域名服务器的查询通常是采用迭代查询
  - 当根域名服务器收到本地域名服务器的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉本地域名服务器：“你下一步应当向哪一个域名服务器进行查询”
  - 然后让本地域名服务器进行后续的查询

#### 名字的高速缓存

- 每个域名服务器都维护一个高速缓存，存放最近用过的名字以及从何处获得名字映射信息的记录
- 可大大减轻根域名服务器的负荷，使因特网上的 DNS 查询请求和回答报文的数量大为减少
- 为保持高速缓存中的内容正确，域名服务器应为每项内容设置计时器，并处理超过合理时间的项（例如，每个 项目只存放两天）
- 当权限域名服务器回答一个查询请求时，在响应中都指明绑定有效存在的时间值
  - 增加此时间值可减少网络开销，而减少此时间值可提高域名转换的准确性

### 6.2 文件传送协议

#### FTP概述

- 文件传送协议 FTP (File Transfer Protocol) 是因特网上使用得最广泛的文件传送协议
- FTP 提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限
- FTP 屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件
- RFC 959 很早就成为了因特网的正式标准

#### FTP 特点

- 文件传送协议 FTP 只提供文件传送的一些基本的服务，它使用 TCP 可靠的运输服务
- FTP 的主要功能是减少或消除在不同操作系统下处理文件的不兼容性
- FTP 使用客户服务器方式
  - 一个 FTP 服务器进程可同时为多个客户进程提供服务
    - FTP 的服务器进程由两大部分组成：
      - 一个主进程，负责接受新的请求
      - 另外有若干个从属进程，负责处理单个请求

#### 主进程的工作步骤如下

- 打开熟知端口（端口号为 21），使客户进程能够连接上
- 等待客户进程发出连接请求
- 启动从属进程来处理客户进程发来的请求
  - 从属进程对客户进程的请求处理完毕后即终止， 但从属进程在运行期间根据需要还可能创建其他一些子进程
- 回到等待状态，继续接受其他客户进程发来的请求
  - 主进程与从属进程的处理是并发地进行

#### 两个连接

- 控制连接在整个会话期间一直保持打开，FTP 客户发出的传送请求通过控制连接发送给服务器端的控制进程，但控制连接不用来传送文件
- 实际用于传输文件的是“数据连接” 
  - 服务器端的控制进程在接收到 FTP 客户发送来的文件传输请求后就创建“数据传送进程”和“数据连接” ，用来连接客户端和服务器端的数据传送进程
- 数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\FTP使用的两个TCP连接.png" alt="FTP使用的两个TCP连接" width="500" height="300" />

#### 两个不同的端口号

- 当客户进程向服务器进程发出建立连接请求时， 要寻找连接服务器进程的熟知端口(21)，同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接
- 接着，服务器进程用自己传送数据的熟知端口(20) 与客户进程所提供的端口号码建立数据传送连接
- 由于FTP使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱

#### 简单文件传送协议 TFTP (Trivial File Transfer Protocol)

- TFTP 是一个很小且易于实现的文件传送协议
- TFTP 使用客户服务器方式和使用 UDP 数据报， 因此 TFTP 需要有自己的差错改正措施
- TFTP 只支持文件传输而不支持交互
- TFTP 没有一个庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别

### 6.3 远程终端协议 TELNET 

- TELNET 是一个简单的远程终端协议，也是因特网的正式标准
- 用户用 TELNET 就可在其所在地通过 TCP 连接注册（即登录）到远地的另一个主机上（使用主机名或 IP 地址）
- TELNET 能将用户的击键传到远地主机，同时也能将远地主机的输出通过 TCP 连接返回到用户屏幕
- 这种服务是透明的，因为用户感觉到好像键盘和显示器是直接连在远地主机上
- 现在由于 PC 机的功能越来越强，用户已较少使用 TELNET 了
- TELNET 也使用客户服务器方式
  - 在本地系统运行 TELNET 客户进程，而在远地主机则运行 TELNET 服务器进程
- 和 FTP 的情况相似，服务器中的主进程等待新的请求，并产生从属进程来处理每一个连接

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\TELNET使用网络虚拟终端NVT格式.png" alt="TELNET使用网络虚拟终端NVT格式" width="500" height="300" />

### 6.4 万维网 WWW

- 万维网 WWW (World Wide Web)并非某种特殊的计算机网络
- 万维网是一个大规模的、联机式的信息储藏所
- 万维网用链接的方法能非常方便地从因特网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息
- 这种访问方式称为“链接“

#### 超媒体与超文本

- 万维网是分布式超媒体(hypermedia)系统，它是超文本(hypertext)系统的扩充
- 一个超文本由多个信息源链接成
  - 利用一个链接可使用户找到另一个文档
  - 这些文档可以位 于世界上任何一个接在因特网上的超文本系统 中
  - 超文本是万维网的基础
- 超媒体与超文本的区别是文档内容不同
  - 超文本文档仅包含文本信息，而超媒体文档还包含其他表示方式的信息，如图形、图像、声音、 动画，甚至活动视频图像

#### 万维网的工作方式

- 万维网以客户服务器方式工作
- 浏览器就是在用户计算机上的万维网客户程序
  - 万维网文档所驻留的计算机则运行服务器程序， 因此这个计算机也称为万维网服务器
- 客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档
- 在一个客户程序主窗口上显示出的万维网文档称为页面(page)

#### 统一资源定位符 URL

- 统一资源定位符 URL 是对可以从因特网上得到的资源的位置和访问方法的一种简洁的表示
- URL 给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位
- 只要能够对资源定位，系统就可以对资源进行各种操作，如存取、更新、替换和查找其属性
- URL 相当于一个文件名在网络范围的扩展
  - 因此 URL 是与因特网相连的机器上的任何可访问对象的一个指针

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\URL的一般形式.png" alt="URL的一般形式" width="500" height="300" />

- <主机> 是存放资源的主机在因特网中的域名
- <端口> 有时可省略，HTTP 的默认端口号是 80

#### 超文本传送协议 HTTP

- 为了使超文本的链接能够高效率地完成， 需要用 HTTP 协议来传送一切必须的信息
- 从层次的角度看，HTTP 是面向事务的 (transaction-oriented)应用层协议，它是万维网上能够可靠地交换文件（包括文本、 声音、图像等各种多媒体文件）的重要基础

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\万维网的工作过程.png" alt="万维网的工作过程" width="500" height="300" />

##### 用户点击鼠标后所发生的事件

- 浏览器分析超链指向页面的 URL
- 浏览器向 DNS 请求解析 www.tsinghua.edu.cn 的 IP 地址
- 域名系统 DNS 解析出清华大学服务器的 IP 地址
- 浏览器与服务器建立 TCP 连接 
- 浏览器发出取文件命令： GET /chn/yxsz/index.htm
- 服务器给出响应，把文件 index.htm 发给浏览器
- TCP 连接释放
- 浏览器显示“清华大学院系设置”文件 index.htm 中的所有文本

##### HTTP 的主要特点

- HTTP 是面向事务的客户服务器协议
- HTTP 1.0 协议是无状态的(stateless)
- HTTP 协议本身也是无连接的，虽然它使用了面向连接的 TCP 向上提供的服务

##### 持续连接 (persistent connection)

- HTTP/1.1 协议使用持续连接
- 万维网服务器在发送响应后仍然在一段时间内保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的 HTTP 请求报文和响应报文
- 这并不局限于传送同一个页面上链接的文档， 而是只要这些文档都在同一个服务器上就行
- 目前一些流行的浏览器（例如，IE 6.0）的默认设置就是使用 HTTP/1.1

##### 持续连接的两种工作方式

- 非流水线方式：客户在收到前一个响应后才能发出下一个请求
  - 这比非持续连接的两倍 RTT 的开销节省了建立 TCP 连接所需的一个 RTT 时间
  - 但服务器在发送完一个对象后，其 TCP 连接就处于空闲状态，浪费了服务器资源
- 流水线方式：客户在收到 HTTP 的响应报文之前就能够接着发送新的请求报文
  - 一个接一个的请求报文到达服务器后，服务器就可连续发回响应报文
  - 使用流水线方式时，客户访问所有的对象只需花费一个 RTT时间，使 TCP 连接中的空闲时间减少，提高了下载文档效率

##### 代理服务器 (proxy server)

- 代理服务器(proxy server)又称为万维网高速缓存(Web cache)，它代表浏览器发出 HTTP 请求
- 万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中
- 当与暂时存放的请求相同的新请求到达时，万维网高速缓存就把暂存的响应发送出去，而不需要按 URL 的地址再去因特网访问该资源

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\使用高速缓存的情况.png" alt="使用高速缓存的情况" width="500" height="300" />

##### HTTP 的报文结构

HTTP 有两类报文： 

- 请求报文——从客户向服务器发送请求报文
- 响应报文——从服务器到客户的回答
- 由于 HTTP 是面向正文的(text-oriented)，因此在报文中的每一个字段都是一些 ASCII 码串， 因而每个字段的长度都是不确定的

##### 请求报文

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\HTTP的报文结构（请求报文）.png" alt="HTTP的报文结构（请求报文）" width="500" height="300" />

- 报文由三个部分组成，即开始行、首部行和实体主体
  - 在请求报文中，开始行就是请求行
- “方法”是面向对象技术中使用的专门名词
  - 所谓“方法”就是对所请求的对象进行的操作，因此这些方法实际上也就是一些命令
  - 因此，请求报文的类型是由它所采用的方法决定的
    - OPTION： 请求一些选项的信息 
    - GET： 请求读取由 URL所标志的信息 
    - HEAD： 请求读取由 URL所标志的信息的首部 
    - POST： 给服务器添加信息（例如，注释） 
    - PUT： 在指明的 URL下存储一个文档 
    - DELETE： 删除指明的 URL所标志的资源 
    - TRACE： 用来进行环回测试的请求报文 
    - CONNECT： 用于代理服务器
- “URL”是所请求的资源的 URL
- “版本”是 HTTP 的版本

##### 响应报文

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\HTTP的报文结构（响应报文）.png" alt="HTTP的报文结构（响应报文）" width="500" height="300" />

- 响应报文的开始行是状态行
  - 状态行包括三项内容，即 HTTP 的版本，状态码， 以及解释状态码的简单短语
- 状态码都是三位数字
  - 1xx 表示通知信息的，如请求收到了或正在进行处理
  - 2xx 表示成功，如接受或知道了
  - 3xx 表示重定向，表示要完成请求还必须采取进一步的行动
  - 4xx 表示客户的差错，如请求中有错误的语法或不能完成
  - 5xx 表示服务器的差错，如服务器失效无法完成请求

#### 超文本标记语言 HTML

### 6.5 电子邮件

### 6.6 动态主机配置协议 DHCP 

### 6.7 简单网络管理协议 SNMP

### 6.8 应用进程跨越网络的通信



