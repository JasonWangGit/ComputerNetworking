# 计算机网络（韩立刚）

## 分层重点协议整理

- 分层的意义：解耦

- **应用层**（应用层 ：能够产生网络流量且能和用户交互的应用程序 + 表示层：加密、压缩 + 会话层：服务器和客户端建立的会话）.
  - HTTP
  - FTP
  - DNS
  - SMTP
  - PoP3

- **运输层**（七层中也称传输层）：可靠传输、不可靠传输
  - TCP
  - UDP

- **网络层**（四层中也称网络层）：IP地址编址、选择最佳路径
  - 网际协议 **IP（Internet Protocol）** ：封装在IP数据报首部
    - 地址解析协议 **ARP （Address Resolution Protocol）** ：封装在IP数据报
      - IP地址 → 物理地址
    - 逆地址解析协议 **RARP （Reverse Address Resolution Protocol）** ：封装在IP数据报
      - 物理地址 → IP地址
    - 网际控制报文协议 **ICMP （Internet Control Message Protocol）**：封装在IP数据报
      - 为了提高 IP 数据报交付成功的机会
    - 网际组管理协议 **IGMP （Internet Group Management Protocol）**：封装在IP数据报
      - 为了使路由器知道多播组成员的信息
  - 内部网关协议 **RIP （Routing Information Protocol）**：封装在UDP数据报
    - RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
  - 内部网关协议 **OSPF （Open Shortest Path First）**：封装在IP数据报
    - 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法
  - 外部网关协议 **BGP（Border Gateway Protocol）**：封装在TCP数据
    - BGP 是不同自治系统的路由器之间交换路由信息的协议
- **数据链路层**（四层中与物理层也合称网络接口层）：封装数据、添加物理层地址（MAC）
  - 封装成帧（首部、尾部）、透明传输（“转义”思想）、差错控制（循环冗余检验 CRC）
  - 点对点协议 **PPP （Point-to-Point Protocol）**
    - 一个将 IP 数据报封装到串行链路的方法
    - 链路控制协议 **LCP （Link Control Protocol）**
    - 网络控制协议 **NCP （Network Control Protocol）**
  - 载波监听多点接入/碰撞检测 **CSMA/CD（Carrier Sense Multiple Access with Collision Detection）**
    - 解决总线网问题
- **物理层**（四层中与数据链路层也合称网络接口层）：电压、接口标准
  - 机械特性（形状、尺寸）、电气特性（电压范围）、功能特性（电平意义）、过程特性（事件顺序）
  - 信号（基带、带通）、通信（单工、半双工、全双工）、信道（对传输媒体的抽象）、传输媒体（双绞线、同轴电缆、光缆、无线传输）、复用技术（频分、波分、时分、统计时分、码分）

## 第 1 章 概述

### 1.1 计算机网络在信息时代中的作用

暂无内容。

### 1.2 因特网概述

#### 术语

- 结点（node）
  - 二叉树中叫节点，网络中叫结点
- 链路（link）
- 主机（host）
- 互联网（internet）
- 因特网（Internet）
  - 当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用 TCP/IP 协议族作为通信的规则
- 因特网服务提供者ISP（Internet Service Provider）
- 万维网WWW（World Wide Web）

### 1.3 因特网的组成

#### 因特网的边缘部分与核心部分

- 边缘部分：由所有连接在因特网上的主机（端系统 end system）组成
  - 两种通信方式
    - 客户服务器方式（C/S 方式）：Client/Server，客户是服务的请求方，服务器是服务的提供方
    - 对等方式（P2P 方式）：Peer-to-Peer，两个主机在通信时并不区分哪一个是服务请求方还是服务提供方
- 核心部分：由大量网络和连接这些网络的路由器组成
  - 在网络核心部分起特殊作用的是路由器（router）
    - 路由器是实现分组交换（packet switching）的关键构件，其任务是转发收到的分组

### 1.4 计算机网络在我国的发展

暂无内容。

### 1.5 计算机网络的类别

暂无内容。

### 1.6 计算机网络的性能

#### 计算机网络的性能指标

- 比特（bit）是计算机中数据量的单位，也是信息论中使用的信息量的单位
  - bit 来源于binary digit，意思是一个“二进制数字”，因此一个比特就是二进制数字中的 一个1或0
- **速率**即数据率（data rate）或比特率（bit rate）是计算机网络中最重要的一个性能指标。速率的单位是 b/s，或kb/s, Mb/s, Gb/s 等
- **带宽**（bandwidth）本来是指信号具有的频带宽度，单位是赫（或千赫、兆赫、 吉赫等）
  - 现在“带宽”是数字信道所能传送的 “最高数据率”的同义语，单位是“比特每秒”，或 b/s （bit/s）

$$
在计算机界，K = 2^{10} = 1024， M = 2^{20}， G = 2^{30}， T = 2^{40}
$$

- **吞吐量**（throughput）表示在单位时间内通过某个网络（或信道、接口）的数据量

- **时延**（delay或 latency）

  - 总时延 = 发送时延 + 传播时延 + 处理时延 + 处理时延
  - 传输时延（发送时延）：发送数据时， 数据块从结点进入到传输媒体所需要的时间
    - 发送时延 = 数据块长度（比特） / 信道带宽（比特/秒）

  - 传播时延：电磁波在信道中需要传播一定的距离而花费的时间
    - 传播时延 = 信道长度（米） / 信号在信道上的传播速率（米/秒）
  - 处理时延：交换结点为存储转发而进行一些必要的处理所花费的时间
  - 排队时延：结点缓存队列中分组排队所经历的时延

- 链路的**时延带宽积**又称为以比特为单位的链路长度

  - 时延带宽积 = 传播时延 × 带宽

- **利用率**

  - 信道利用率指出某信道有百分之几的时间是被利用的（有数据通过）
    - 完全空闲的信道的利用率是零
  - 网络利用率则是全网络的信道利用率的加权平均值
  - 根据排队论的理论，当某信道的利用率增大时，该信道引起的时延也就迅速增加

### 1.7 计算机网络的体系结构

#### 分层的好处（解耦）

- 各层之间是独立的
- 灵活性好
- 结构上可分割开
- 易于实现和维护
- 能促进标准化工作

#### OSI

- 应用层（Application）
  - 能够产生网络流量且能和用户交互的应用程序

- 表示层（Presentation）
  - 加密、压缩

- 会话层（Session）
  - 服务器和客户端建立的会话
- 传输层（Transport）
  - 可靠传输、不可靠传输

- 网络层（Network）
  - IP地址编址、选择最路径

- 数据链路层（Data Link）
  - 封装数据、添加物理层地址（MAC）

- 物理层（Physical）
  - 电压、接口标准

#### TCP/IP

- 应用层（Application）
  - 应用层 + 表示层 + 会话层
- 运输层（Transport）
- 网际层（Internet）
  - 网络层
- 网络接口层（Network Access）
  - 数据链路层 + 物理层

#### 五层协议

- 应用层（Application）
- 运输层（Transport）
- 网络层（Network）
- 数据链路层（Data Link）
- 物理层（Physical）

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\主机1向主机2发送数据.png" alt="主机1向主机2发送数据" style="zoom:30%;" />

## 第 2 章 物理层

### 2.1 物理层的基本概念

物理层的主要任务描述为确定与传输媒体的接口的一些特性。

- 机械特性：指明接口所用接线器的形状和尺寸 、引线数目和排列、固定和锁定装置等等
- 电气特性：指明在接口电缆的各条线上出现的电压的范围
- 功能特性：指明某条线上出现的某一电平的电压表示何种意义
- 过程特性：指明对于不同功能的各种可能事件的出现顺序

### 2.2 数据通信的基础知识

#### 数据通信系统的模型

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%A8%A1%E5%9E%8B.png" alt="数据通信系统的模型" style="zoom:30%;" />

#### 术语

- 数据（data）
- 信号（signal）
- 模拟的（analogous）
- 数字的（digital）
- 码元（code）：在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形

#### 有关信号的几个基本概念

- 单向通信（单工通信）
- 双向交替通信（半双工通信）
- 双向同时通信（全双工通信）

#### 基带（baseband）信号和带通（band pass）信号

- 基带信号（即基本频带信号）
- 带通信号：把基带信号经过载波调制后，把信号的频率范围搬移到较高的频段以便在信道中传输（即仅在一 段频率范围内能够通过信道）

#### 几种最基本的调制方法

- 调幅（AM）
  - 正交振幅调制 QAM （Quadrature Amplitude Modulation）
- 调频（FM）
- 调相（PM） 

#### 奈氏准则

- 1924 年，奈奎斯特（Nyquist）就推导出了著名的奈氏准则
- 他给出了在假定的理想条件下，为了避免码间串扰，码元的传输速率的上限值
- 在任何信道中，码元传输的速率是有上限的， 否则就会出现码间串扰的问题，使接收端对码元的判决（即识别）成为不可能

#### 香农公式

- 香农（Shannon）用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率
- 信道的极限信息传输速率 C 可表达为

$$
C = log_2(1 + S / N)
$$

- W 为信道的带宽（以 Hz 为单位）
- S 为信道内所传信号的平均功率
- N 为信道内部的高斯噪声功率

##### 香农公式表明

- 信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高
- 只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输
- 若信道带宽 W 或信噪比 S/N 没有上限（当然实际信道不可能是这样的）
  - 则信道的极限信息传输速率 C 也就没有上限
- 实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少
- 对于频带宽度已确定的信道，如果信噪比不能再提高了，并且码元传输速率也达到了上限值，那么还有办法提高信息的传输速率
  - 这就是用编码的方法让每一个码元携带更多比特的信息量

### 2.3 物理层下面的传输媒体

#### 导向传输媒体

- 双绞线 
  - 屏蔽双绞线 STP （Shielded Twisted Pair） 
  - 无屏蔽双绞线 UTP （Unshielded Twisted Pair） 
- 同轴电缆 
  - 50 Ω同轴电缆 
  - 75 Ω同轴电缆 
- 光缆
  - 多模光纤
  - 单模光纤

#### 非导向传输媒体

- 短波通信主要是靠电离层的反射，但短波信道的通信质量较差
- 微波在空间主要是直线传播
  - 地面微波接力通信
  - 卫星通信

### 2.4 信道复用技术

- 频分复用FDM （Frequency Division Multiplexing）

- 时分复用TDM （Time Division Multiplexing） 
  - 时分复用可能会造成线路资源的浪费

- 统计时分复用STDM （Statistic TDM） 
  - 避免时分复用的浪费
- 波分复用 WDM （Wavelength Division Multiplexing）
  - 波分复用就是光的频分复用
- 码分复用 CDM （Code Division Multiplexing）
  - 码分多址 CDMA （Code Division Multiple Access）
    - 各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰
    - 这种系统发送的信号有很强的抗干扰能力， 其频谱类似于白噪声，不易被敌人发现
    - 每一个比特时间划分为 m 个短的间隔，称为码片（chip）
    - 每个站分配的码片序列不仅必须各不相同， 并且还必须互相正交（orthogonal）
    - 在实用的系统中是使用伪随机码序列

### 2.5 数字传输系统

- 脉码调制 PCM 体制
  - 脉码调制 PCM 体制最初是为了在电话局之间的中继线上传送多路的电话
- 同步光纤网 SONET 和同步数字系列 SDH 
  - 一般可认为 SDH 与 SONET 是同义词

### 2.6 宽带接入技术

- xDSL 技术
  - 就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务
- 光纤同轴混合网 HFC （Hybrid Fiber Coax）
  - HFC 网是在目前覆盖面很广的有线电视网 CATV 的基础上开发的一种居民宽带接入网
- FTTx 技术
  - FTTx（光纤到……）也是一种实现宽带居民接入网的方案

## 第 3 章 数据链路层

数据链路层使用的信道主要有以下两种类型：

- 点对点信道：这种信道使用一对一的点对点通信方式
- 广播信道：这种信道使用一对多的广播通信方式，因此过程比较复杂
  - 广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据收发

### 3.1 使用点对点信道的数据链路层

#### 数据链路和帧

- 链路（link）是一条无源的点到点的物理线路段，中间没有任何其他的交换结点
  - 一条链路只是一条通路的一个组成部分
- 数据链路（data link） 除了物理线路外，还必须有通信协议来控制这些数据的传输
  - 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件
    - 一般的适配器都包括了数据链路层和物理层这两层的功能。
  - 若把实现这些协议的硬件和软件加到链路上，就构成了数据链路
  - 数据链路层传送的是帧

#### 三个基本问题

- 封装成帧
  - 封装成帧（framing）就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧
    - 确定帧的界限
  - 首部和尾部的一个重要作用就是进行帧定界
- 透明传输
  - 发送端的数据链路层在数据中出现控制字符 “SOH”或“EOT”的前面插入一个转义字符 “ESC”（其十六进制编码是 1B）
  - 字节填充（byte stuffing）或字符填充（character stuffing）
    - 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符
  - 如果转义字符也出现数据当中，那么应在转义字符前面插入一个转义字符
    - 当接收端收到连续的两个转义字符时，就删除其中前面的一个
- 差错控制
  - 在传输过程中可能会产生比特差错：1 可能会变成 0 而 0 也可能变成 1
  - 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率 BER （Bit Error Rate）
    - 误码率与信噪比有很大的关系
  - 在数据链路层传送的帧中，广泛使用了循环冗余检验 CRC 的检错技术
    - 在数据后面添加上的冗余码称为帧检验序列 FCS （Frame Check Sequence）
      - CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码
      - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法
    - 仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受（accept）
    - “无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错” 。 
      - 也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）
    - 要做到“可靠传输”（即发送什么就收到什么） 就必须再加上确认和重传机制

### 3.2 点对点协议 PPP

现在全世界使用得最多的数据链路层协议是点对点协议 PPP （Point-to-Point Protocol）。

- 用户使用拨号电话线接入因特网时，一般都是使用 PPP 协议

#### PPP 协议的组成

-  一个将 IP 数据报封装到串行链路的方法 
- 链路控制协议 LCP （Link Control Protocol）
- 网络控制协议 NCP （Network Control Protocol）

#### PPP 协议的帧格式

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\PPP协议的帧格式.png" alt="PPP协议的帧格式" style="zoom:30%;" />

#### 透明传输问题

- 当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的 做法一样）
  - PPP 协议用在 SONET/SDH 链路时，是使用同步传输（一连串的比特连续传送）
    - 这时 PPP 协议采用零比特填充方法来实现透明传输
      - 在发送端，只要发现有 5 个连续 1，则立即填入一个 0
- 当 PPP 用在异步传输时，就使用一种特殊的字符填充法
  - 将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列（0x7D, 0x5E）
  - 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变

### 3.3 使用广播信道的数据链路层

#### 局域网的数据链路层

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。

##### 媒体共享技术

- 静态划分信道 
  - 频分复用、时分复用、波分复用、码分复用 
- 动态媒体接入控制（多点接入） 
  - 随机接入 
  - 受控接入，如多点线路探询（polling），或轮询

##### 以太网的两个标准

- DIX Ethernet V2
- IEEE 802.3（简称为以太网）

##### 数据链路层的两个子层

- ~~逻辑链路控制 LLC（Logical Link Control）子层~~
- 媒体接入控制 MAC（Medium Access Control）子层

##### 适配器的作用

网络接口板又称为通信适配器（adapter） 或网络接口卡 NIC （Network Interface Card），或“网卡”。

- 进行串行/并行转换
- 对数据进行缓存
- 在计算机的操作系统安装设备驱动程序
- 实现以太网协议

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\计算机通过适配器和局域网进行通信.png" alt="计算机通过适配器和局域网进行通信" style="zoom:30%;" />

#### CSMA/CD 协议（总线网）

最初的以太网是将许多计算机都连接到一根总线上。当初认为这样的连接方法既简单又可靠， 因为总线上没有有源器件。

##### 以太网的广播方式发送

总线上的每一个工作的计算机都能检测到 B 发送的数据信号。

##### 为了通信的简便以太网采取了两种重要的措施

- 采用较为灵活的无连接的工作方式，即不必先建立连接就可以直接发送数据
- 以太网对发送的数据帧不进行编号，也不要求对方发回确认
  - 这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的

##### 以太网提供的服务：曼彻斯特（Manchester）编码

- 以太网提供的服务是不可靠的交付，即尽最大努力的交付 
- 当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做
  - 差错的纠正由高层来决定。 
  - 如果高层发现丢失了一些数据而进行重 传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送

##### 载波监听多点接入/碰撞检测 CSMA/CD（Carrier Sense Multiple Access with Collision Detection）

- “多点接入”表示许多计算机以多点接入的方式连接在一根总线上。 
- “载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据
  - 如果有，则暂时不要发送数据，以免发生碰撞
  - 总线上并没有什么“载波”
    - 因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号
- “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小
  - 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）
    - 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞
  - 所谓“碰撞”就是发生了冲突
    - 因此“碰撞检测”也称为“冲突检测”
  - 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送， 免得继续浪费网络资源，然后等待一段随机时间后再次发送
  - 争用期（碰撞窗口）
    - 最先发送数据帧的站，在发送数据帧后至多经过时间 2τ（两倍的端到端往返时延） 就可知道发送的数据帧是否遭受了碰撞
  - 二进制指数类型退避算法（truncated binary exponential type）
    - 发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据
  - 最短有效帧长（64 字节）
    - 以太网取 51.2 μs 为争用期的长度
    - 对于 10 Mb/s 以太网，在争用期内可发送 512 bit，即 64 字节
    - 以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突
    - 如果发生冲突，就一定是在发送的前 64 字节之内
    - 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节
    - 以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧
  - 强化碰撞
    - 当发送数据的站一旦发现发生了碰撞时： 
      - 立即停止发送数据
      - 再继续发送若干比特的人为干扰信号（jamming signal），以便让所有用户都知道现在已经发生了碰撞

##### 重要特性

- 使用 CSMA/CD 协议的以太网不能进行全双工通信而只能进行双向交替通信（半双工通信）
- 每个站在发送数据之后的一小段时间内， 存在着遭遇碰撞的可能性
- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率

### 3.4 使用广播信道的以太网

#### 使用集线器的星形拓扑

- 传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线
- 这种以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做集线器（hub） 

##### 集线器的一些特点

- 集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个传统的以太网那样运行
- 使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线
- 集线器很像一个多接口的转发器，工作在物理层

#### 以太网的信道利用率

##### 参数 a

- 要提高以太网的信道利用率，就必须减小 τ 与 T0 之比
- 在以太网中定义了参数 a，它是以太网单程端到端时延 τ 与帧的发送时间 T0 之比

$$
a = \frac{\tau}{T_0}
$$

- a→0 表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高
- a 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低

##### 对以太网参数的要求

- 当数据率一定时，以太网的连线的长度受到限制，否则 τ 的数值会太大
- 以太网的帧长不能太短，否则 T0 的值会太小，使 a 值太大

#### 以太网的 MAC 层

- 在局域网中，硬件地址又称为物理地址， 或 MAC 地址
- 常用的以太网MAC帧格式有两种标准 ： 
  - （最常用）DIX Ethernet V2 标准
  - IEEE 的 802.3 标准

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E4%BB%A5%E5%A4%AA%E7%BD%91%E7%9A%84MAC%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="以太网的MAC帧格式" style="zoom:30%;" />

##### 48 位的 MAC 地址

- IEEE 的注册管理机构 RA 负责向厂家分配地址字段的前三个字节（即高位 24 位）
- 地址字段中的后三个字节（即低位 24 位）由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址
- 一个地址块可以生成2^24个不同的地址。这种 48 位地址称为 MAC-48，它的通用名称是EUI-48
- “MAC地址”实际上就是适配器地址或适配器标识符EUI-48

##### 适配器检查 MAC 地址

- 适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址
  - 如果是发往本站的帧则收下，然后再进行其他的处理
  - 否则就将此帧丢弃，不再进行其他的处理
- “发往本站的帧”包括以下三种帧： 
  - 单播（unicast）帧（一对一） 
  - 广播（broadcast）帧（一对全体） 
  - 多播（multicast）帧（一对多）

##### 无效的 MAC 帧

- 数据字段的长度与长度字段的值不一致
- 帧的长度不是整数个字节
- 用收到的帧检验序列 FCS 查出有差错
- 数据字段的长度不在 46 ~ 1500 字节之间
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间
- 对于检查出的无效 MAC 帧就简单地丢弃
- 以太网不负责重传丢弃的帧

##### 帧间最小间隔

- 帧间最小间隔为 9.6 μs，相当于 96 bit 的发送 时间
- 一个站在检测到总线开始空闲后，还要等待 9.6 μs 才能再次发送数据
- 这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备

### 3.5 扩展的以太网

- 在物理层扩展局域网
  - 主机使用光纤和一对光纤调制解调器连接到集线器
  - 用多个集线器可连成更大的局域网
    - 用集线器组成更大的局域网都在一个碰撞域中
- 在数据链路层扩展局域网
  - 在数据链路层扩展局域网是使用网桥
    - 网桥工作在数据链路层，它根据 MAC 帧的目的地址对收到的帧进行转发
    - 网桥具有过滤帧的功能
      - 当网桥收到一个帧时， 并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口
    - 网桥使各网段成为隔离开的碰撞域
    - 网桥只适合于用户数不太多（不超过几百个）和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞
      - 这就是所谓的广播风暴
    - 网桥不改变它转发的帧的源地址
  - 用以太网交换机扩展局域网
    - 利用以太网交换机可以很方便地实现虚拟局域网
      - 虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组
      - 虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网

<img src="https://raw.githubusercontent.com/JasonWangGit/ComputerNetworking/master/image/%E8%99%9A%E6%8B%9F%E5%B1%80%E5%9F%9F%E7%BD%91%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="虚拟局域网使用的以太网帧格式" style="zoom:30%;" />

#### 网桥和集线器（或转发器）不同

- 集线器在转发帧时，不对传输媒体进行检测
- 网桥在转发帧之前必须执行 CSMA/CD 算法
  - 若在发送过程中出现碰撞，就必须停止发送和进行退避

#### 透明网桥

- 目前使用得最多的网桥是透明网桥（transparent bridge）
- “透明”是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的
- 透明网桥是一种即插即用设备，其标准是 IEEE 802.1D
- 网桥应当按照以下自学习算法处理收到的帧和建立转发表

#### 源路由网桥

- 透明网桥容易安装，但网络资源的利用不充分
- 源路由（source route）网桥在发送帧时将详细的路由信息放在帧的首部中
- 源站以广播方式向欲通信的目的站发送一个发现帧， 每个发现帧都记录所经过的路由
- 发现帧到达目的站时就沿各自的路由返回源站
  - 源站在得知这些路由后，从所有可能的路由中选择出 一个最佳路由
  - 凡从该源站向该目的站发送的帧的首部，都必须携带源站所确定的这一路由信息

#### 多接口网桥：以太网交换机

- 交换式集线器常称为以太网交换机（switch）或第二层交换机（表明此交换机工作在数据链路层）
- 以太网交换机通常都有十几个接口
  - 因此，以太网交换机实质上就是一个多接口的网桥，可见交换机工作在数据链路层
- 以太网交换机的每个接口都直接与主机相连，并且一般都工作在全双工方式
- 交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据
- 以太网交换机由于使用了专用的交换结构芯片， 其交换速率就较高
- 独占传输媒体的带宽
  - 对于普通 10 Mb/s 的共享式以太网，若共有 N 个 用户，则每个用户占有的平均带宽只有总带宽（10 Mb/s）的 N 分之一
  - 使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽， 因此对于拥有 N 对接口的交换机的总容量为 N×10 Mb/s
    - 这正是交换机的最大优点。

### 3.6 高速以太网

速率达到或超过 100 Mb/s 的以太网称为高速以太网。

- 100BASE-T 以太网（快速以太网 Fast Ethernet）
  - 可在全双工方式下工作而无冲突发生
    - 因此，不使用 CSMA/CD 协议
  - MAC 帧格式仍然是 802.3 标准规定的
  - 保持最短帧长不变，但将一个网段的最大电缆长度减小到 100 m
  - 帧间时间间隔从原来的 9.6 μs 改为现在 的 0.96 μs
- 吉比特以太网
  - 允许在 1 Gb/s 下全双工和半双工两种方式工作
  - 使用 802.3 协议规定的帧格式
  - 在半双工方式下使用 CSMA/CD 协议 （全双工方式不需要使用 CSMA/CD 协议）
  - 与 10BASE-T 和 100BASE-T 技术向后兼容
- 10 吉比特以太网
  - 10 吉比特以太网与 10 Mb/s，100 Mb/s 和 1 Gb/s 以太网的帧格式完全相同
  - 10 吉比特以太网还保留了 802.3 标准规定的以太网最小和最大帧长，便于升级
  - 10 吉比特以太网不再使用铜线而只使用光纤作为传输媒体
  - 10 吉比特以太网只工作在全双工方式，因此没有争用问题，也不使用 CSMA/CD 协议

## 第 4 章 网络层

### 4.1 网络层提供的两种服务

- 网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务
- 网络在发送分组时不需要先建立连接
  - 每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）
- 网络层不提供服务质量的承诺
  - 即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限
- 由于传输网络不提供端到端的可靠传输服务， 这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）
- 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责（包括差错处理、流量控制等）
- 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用
- 因特网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性

#### 虚电路服务

- H1 发送给 H2 的所有分组都沿着同一条虚电路传送

- 虚电路表示这只是一条逻辑上的连接， 分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接
- 请注意，电路交换的电话通信是先建立了一条真正的连接
  - 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样

#### 数据报服务

- H1 发送给 H2 的分组可能沿着不同路径传送

#### 虚电路服务与数据报服务的对比

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\虚电路服务与数据报服务的对比.png" alt="虚电路服务与数据报服务的对比" style="zoom:30%;" />

### 4.2 网际协议 IP

- 网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一
- 与 IP 协议配套使用的还有四个协议： 
  - 地址解析协议 ARP （Address Resolution Protocol） 
  - 逆地址解析协议 RARP （Reverse Address Resolution Protocol） 
  - 网际控制报文协议 ICMP （Internet Control Message Protocol） 
  - 网际组管理协议 IGMP （Internet Group Management Protocol）

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\网际层的IP协议及配套协议.png" alt="网际层的IP协议及配套协议" style="zoom:30%;" />

#### 虚拟互连网络

- 中间设备又称为中间系统或中继（relay）系统
  - 物理层中继系统：转发器（repeater）
    - 集线器
  - 数据链路层中继系统：网桥或桥接器（bridge）
    - 网桥、交换机
    - 当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络
  - 网络层中继系统：路由器（router）
    - 互联网都是指用路由器进行互连的网络
    - 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关
  - 网桥和路由器的混合物：桥路器（brouter）
  - 网络层以上的中继系统：网关（gateway）
    - 网关由于比较复杂，目前使用得较少
- 所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络
- 使用 IP 协议的虚拟互连网络可简称为 IP 网
- 使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样， 而看不见互连的各具体的网络异构细节

#### 分类的 IP 地址

- 每一类地址都由两个固定长度的字段组成
  - 其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络
  - 而另一个字段则是主机号 host-id，它标志该主机 （或路由器）

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\IP地址中的网络号字段和主机号字段.png" alt="IP地址中的网络号字段和主机号字段" style="zoom:30%;" />

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\常用的三种类别的IP地址.png" alt="常用的三种类别的IP地址" style="zoom:30%;" />

##### IP地址的一些重要特点

- IP 地址是一种分等级的地址结构
  - IP地址管理机构在分配 IP地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配
  - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间
- 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口
  - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的
    - 这种主机称为多归属主机 （multihomed host）
  - 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址
- 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id
- 所有分配到网络号 net-id 的网络，范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的

#### IP 地址与硬件地址

- IP层抽象的互联网屏蔽了下层很复杂的细节 
  - 在抽象的网络层上讨论问题，就能够使用 统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\IP地址与硬件地址.png" alt="IP地址与硬件地址" style="zoom:30%;" />

#### 地址解析协议 ARP 和 逆地址解析协议 RARP 

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\地址解析协议 ARP 和 逆地址解析协议 RARP.png" alt="地址解析协议 ARP 和 逆地址解析协议 RARP" style="zoom:30%;" />

#### 地址解析协议 ARP

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址
- 每一个主机都设有一个 ARP 高速缓存（ARP cache），里面有所在的局域网上的各主机和路由器 的 IP 地址到硬件地址的映射表
- 当主机 A 欲向本局域网上的某个主机 B 发送 IP 数 据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址
  - 如有，就可查出其对应的硬件地址， 再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址

##### 应当注意的问题

- ARP 是解决同一个局域网上的主机或路由器 的 IP 地址和硬件地址的映射问题
- 如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络
  - 剩下的工作就由下一个网络来做
- 从IP地址到硬件地址的解析是自动进行的， 主机的用户对这种地址解析过程是不知道的
- 只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址

##### ARP 高速缓存的作用

- 为了减少网络上的通信量，主机 A 在发送 其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组
- 当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己 的 ARP 高速缓存中
  - 这对主机 B 以后向 A 发送数据报时就更方便了

#### 逆地址解析协议 RARP 

- 逆地址解析协议 RARP 使只知道自己硬件地址的主机能够知道其 IP 地址
- 这种主机往往是无盘工作站
  - 因此 RARP 协议目前已很少使用

#### IP 数据报的格式

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\IP 数据报的格式.png" alt="IP 数据报的格式" style="zoom:30%;" />

- 版本——占 4 位，指 IP 协议的版本目前的 IP 协议版本号为 4 （即 IPv4）
- 首部长度——占 4 位，可表示的最大数值 是 15 个单位（一个单位为 4 字节） 因此 IP 的首部长度的最大值是 60 字节
- 区分服务——占 8 位，用来获得更好的服务在旧标准中叫做服务类型，但实际上一直未被使用过
  - 1998 年这个字段改名为区分服务
  - 只有在使用区分服务（DiffServ）时，这个字段才起作用
  - 在一般的情况下都不使用这个字段
- 总长度——占 16 位，指首部和数据之和的长度， 单位为字节，因此数据报的最大长度为 65535 字节
  - 总长度必须不超过最大传送单元 MTU
- 标识（identification） 占 16 位， 它是一个计数器，用来产生数据报的标识
- 标志（flag） 占 3 位，目前只有前两位有意义
  - 标志字段的最低位是 MF （More Fragment）
    - MF = 1 表示后面“还有分片”
    - MF = 0 表示最后一个分片
  -  标志字段中间的一位是 DF （Don't Fragment） 
    - 只有当 DF = 0 时才允许分片
- 片偏移（12 位）指出：较长的分组在分片后某片在原分组中的相对位置
  - 片偏移以 8 个字节为偏移单位。
- 生存时间（8 位）记为 TTL （Time To Live） 
  - 数据报在网络中可通过的路由器数的最大值
- 协议（8 位）字段指出此数据报携带的数据使用何种协议：TCP、UDP、ICMP、IGMP、OSPF
  - 以便目的主机的 IP 层将数据部分上交给哪个处理过程
- 首部检验和（16 位）字段只检验数据报的首部，不检验数据部分
  - 这里不采用 CRC 检验码而采用简单的计算方法
- 源地址和目的地址都各占 4 字节

##### IP 数据报首部的可变部分

- IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富
- 选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目
- 增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的
  - 这就增加了每一个路由器处理数据报的开销
- 实际上这些选项很少被使用

#### IP 层转发分组的流程

- 若按目的主机号来制作路由表， 则所得出的路由表就会过于庞大
- 但若按主机所在的网络地址来制作路由表， 那么每一个路由器中的路由表就只包含 4 个项目
  - 这样就可使路由表大大简化
- 在路由表中，对每一条路由，最主要的是 （目的网络地址，下一跳地址）

##### 查找路由表

- 特定主机路由
  - 这种路由是为特定的目的主机指明一个路由
- 默认路由（default route）
  - 路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间
  - 这种转发方式在一个网络只有很少的对外连接时是很有用的
- 默认路由在主机发送 IP 数据报时往往更能显示出它的好处
- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和因特网连接，那么在这种情况下使用默认路由是非常合适的。

##### 必须强调指出

- IP 数据报的首部中没有地方可以用来指明“下 一跳路由器的 IP 地址” 
- 当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件
- 网络接口软件使用 ARP负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器

### 4.3 划分子网和构造超网

- 划分子网纯属一个单位内部的事情
  - 单位对外仍然表现为没有划分子网的网络
- 从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位
- 凡是从其他网络发送给本单位某个主机的 IP 数据报， 仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器
- 然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网
- 最后就将 IP 数据报直接交付目的主机

#### 划分子网后变成了三级结构

- 子网掩码（subnet mask）
- （IP地址） AND （子网掩码） = 网络地址

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\IP地址的各字段和子网掩码.png" alt="IP地址的各字段和子网掩码" style="zoom:30%;" />

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\默认子网掩码.png" alt="默认子网掩码" style="zoom:30%;" />

##### 子网掩码是一个重要属性

- 子网掩码是一个网络或一个子网的重要属性
- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器
- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码
- 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码

#### 无分类编址 CIDR（[分IP时用CIDR更加方便]（https://www.zhihu.com/question/364427671/answer/960814680））

- CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间
- CIDR 使用各种长度的“网络前缀”（network-prefix）来代替分类地址中的网络号和子网号
- IP 地址从三级编址（使用子网掩码）又回到了两级编址
- CIDR 还使用“斜线记法”（slash notation），它又称为CIDR记法，即在 IP 地址面加上一个斜线“/”， 然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）
- CIDR 把网络前缀都相同的连续的 IP 地址组成 “CIDR 地址块”

##### 路由聚合（route aggregation） 

- 一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由
- 路由聚合也称为构成超网（supernetting）
- CIDR 虽然不使用子网了，但仍然使用“掩码” 这一名词（但不叫子网掩码）
- 对于 /20 地址块，它的掩码是 20个连续的 1
  - 斜线记法中的数字就是掩码中1的个数
- 前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C 类地址
- 这些 C 类地址合起来就构成了超网
- CIDR 地址块中的地址数一定是 2 的整数次幂
- 网络前缀越短，其地址块所包含的地址数就越多
- 而在三级结构的IP地址中， 划分子网是使网络前缀变长

##### CIDR 记法的其他形式

- 128.14.32.0/20
- 10.0.0.0/10 可简写为 10/10，也就是把点分十进制中低位连续的 0 省略
- 网络前缀的后面加一个星号 * 的表示方法如 00001010 00*
  - 在星号 * 之前是网络前缀， 而星号 * 表示 IP 地址中的主机号，可以是任意值

##### 最长前缀匹配

- 使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成
  - 在查找路由表时可能会得到不止一个匹配结果
- 应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配（longest-prefix matching） 
- 网络前缀越长，其地址块就越小，因而路由就越具体（more specific） 
- 最长前缀匹配又称为最长匹配或最佳匹配

##### 使用二叉线索查找路由表

- 当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题
- 为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找
  - 这里最常用的就是二叉线索（binary trie）
- IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址
- 为了提高二叉线索的查找速度，广泛使用了各种压缩技术。

### 4.4 网际控制报文协议 ICMP

- 为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP （Internet Control Message Protocol）
- ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告
- ICMP 不是高层协议，而是 IP 层的协议
- ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去
- ICMP 报文的种类有两种
  - 即 ICMP 差错报告报文
    - 终点不可达 
    - 源点抑制（Source quench） 
    - 时间超过 
    - 参数问题 
    - 改变路由（重定向）（Redirect）
  - ICMP 询问报文
    - 回送请求和回答报文 
    - 时间戳请求和回答报文

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\ICMP报文的格式.png" alt="ICMP报文的格式" style="zoom:30%;" />]

#### PING （Packet InterNet Groper） 

- PING 用来测试两个主机之间的连通性
- PING 使用了 ICMP 回送请求与回送回答报文
  - PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP

### 4.5 因特网的路由选择协议

- 静态路由选择策略——即非自适应路由选择， 其特点是简单和开销较小，但不能及时适应网络状态的变化
- 动态路由选择策略——即自适应路由选择， 其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大

#### 自治系统 AS （Autonomous System）

- 自治系统 AS 的定义：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由
- 现在对自治系统 AS 的定义是强调下面的事实： 尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略

##### 因特网有两大类路由选择协议

- 内部网关协议 IGP （Interior Gateway Protocol） 即在一个自治系统内部使用的路由选择协议
  - 在自治系统内部的路由选择叫做域内路由选择（intradomain routing） 
  - 目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议
- 外部网关协议EGP （External Gateway Protocol） 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中
  - 自治系统之间的路由选择也叫做域间路由选择（interdomain routing）
  - 这样的协议就是外部网关协议 EGP
  - 在外部网关协议中目前使用最多的是 BGP-4。

#### 内部网关协议 RIP （Routing Information Protocol）

- 路由信息协议 RIP 是内部网关协议 IGP 中最先得到广泛使用的协议
- RIP 是一种分布式的基于距离向量的路由选择协议
- RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录
- 仅和相邻路由器交换信息
- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔交换路由信息，例如， 每隔 30 秒

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\RIP2协议的报文格式.png" alt="RIP2协议的报文格式" style="zoom:30%;" />

##### “距离”的定义

- 从一路由器到直接连接的网络的距离定义为 1
- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1
- RIP协议中的“距离”也称为“跳数”（hop count），因为每经过一个路由器，跳数就加 1
- 这里的“距离”实际上指的是“最短距离” 
- RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短” 
- RIP 允许一条路径最多只能包含 15 个路由器
- “距离”的最大值为16 时即相当于不可达
  - 可见 RIP 只适用于小型互联网
- RIP 不能在两个网络之间同时使用多条路由。
  - RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速（低时延）但路由器较多的路由

##### 路由表的建立

- 路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）
- 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址
- RIP 协议的收敛（convergence）过程较快，即在自治系统中所有的结点都得到正确的路由选择信息的过程

##### RIP 协议的优缺点

- RIP 存在的一个问题是当网络出现故障时，要 经过比较长的时间才能将此信息传送到所有的路由器
- RIP 协议最大的优点就是实现简单，开销较小
- RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）
- 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加
- 这就是好消息传播得快，而坏消息传播得慢
  - 网络出故障的传播时间往往需要较长的时间（例如数分钟）。这是 RIP 的一个主要缺点

#### 内部网关协议 OSPF （Open Shortest Path First）

- “开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的
- “最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法SPF
- OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”
- 是分布式的链路状态协议

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\OSPF分组.png" alt="OSPF分组" style="zoom:30%;" />

##### 三个要点

- 向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法
- 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息
- “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”（metric）
- 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息

##### 划分区域

- 在上层的区域叫作主干区域（backbone area）
- 主干区域的标识符规定为0.0.0.0
- 主干区域的作用是用来连通其他在下层的区域

##### OSPF 直接用 IP 数据报传送

- OSPF 不用 UDP 而是直接用 IP 数据报传送
- OSPF 构成的数据报很短
- 这样做可减少路由信息的通信量
- 数据报很短的另一好处是可以不必将长的数据报分片传送
  - 分片传送的数据报只要丢失一个， 就无法组装成原来的数据报，而整个数据报就必须重传

##### OSPF 的五种分组类型

- 类型1，问候（Hello）分组
- 类型2，数据库描述（Database Description）分组
- 类型3，链路状态请求（Link State Request）分组
- 类型4，链路状态更新（Link State Update）分组， 用洪泛法对全网更新链路状态
- 类型5，链路状态确认（Link State Acknowledgment） 分组。

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\OSPF的基本操作.png" alt="OSPF的基本操作" style="zoom:30%;" />

##### OSPF 的其他特点

- OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态
- 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系
  - 因此当互联网规模很大时， OSPF 协议要比距离向量协议 RIP 好得多
- OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms

#### 外部网关协议 BGP

- BGP 是不同自治系统的路由器之间交换路由信息的协议
- 边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\BGP报文具有通用的首部.png" alt="BGP报文具有通用的首部" style="zoom:30%;" />

##### BGP 发言人 （BGP speaker）

- 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人”
- 一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器
- 一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接， 然后在此连接上交换 BGP 报文以建立 BGP 会话（session），利用 BGP 会话交换路由信息
- 使用 TCP 连接能提供可靠的服务，也简化了路由选择协议
- 使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站或对等站

##### BGP 协议的特点

- BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多
- 每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂
- BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列
- 在BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表
  - 但以后只需要在发生变化时更新有变化的部分
    - 这样做对节省网络带宽和减少路由器的处理开销方面都有好处

##### BGP-4 共使用四种报文

- 打开（OPEN）报文，用来与相邻的另一个BGP 发言人建立关系
- 更新（UPDATE）报文，用来发送某一路由的信息，以及列出要撤消的多条路由
- 保活（KEEPALIVE）报文，用来确认打开报文和周期性地证实邻站关系
- 通知（NOTIFICATION）报文，用来发送检测到的差错

#### 路由器在网际互连中的作用

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\典型的路由器的结构.png" alt="典型的路由器的结构" style="zoom:30%;" />

##### “转发”和“路由选择”的 区别

- “转发”（forwarding）就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去
- “路由选择”（routing）则是按照分布式算法， 根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由
- 路由表是根据路由选择算法得出的
  - 而转发表是从路由表得出的

##### 输入端口对线路上收到的分组的处理

- 数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理
  - 这会产生一定的时延

<img src="D:\Program Files\sts-bundle\source\ComputerNetworking\image\输入端口对线路上收到的分组的处理.png" alt="输入端口对线路上收到的分组的处理" style="zoom:30%;" />

##### 分组丢弃

- 若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃
- 路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因

### 4.6 IP 多播

- 多播可明显地减少网络中资源的消耗

#### IP 多播的一些特点

- 多播使用组地址—— IP 使用 D 类地址支持多播
  - 多播地址只能用于目的地址， 而不能用于源地址
- 永久组地址——由因特网号码指派管理局 IANA 负责指派
- 动态的组成员 
- 使用硬件进行多播

#### 网际组管理协议 IGMP 和多播路由选择协议

- 为了使路由器知道多播组成员的信息， 需要利用网际组管理协议 IGMP （Internet Group Management Protocol）
  - IGMP 并非在因特网范围内对所有多播组成员进行管理的协议
  - IGMP 不知道 IP 多播组包含的成员数， 也不知道这些成员都分布在哪些网络上
  - IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机 （严格讲，是主机上的某个进程）参加或退出了某个多播组
- 连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作， 以便把多播数据报用最小代价传送给所有的组成员
  - 这就需要使用多播路由选择协议
    - 多播路由选择协议尚未标准化

##### 网际组管理协议 IGMP

- 和 ICMP 相似，IGMP 使用 IP 数据报传递其报文（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务
- 因此，我们不把 IGMP 看成是一个单独的协议，而是属于整个网际协议 IP 的一个组成部分

### 4.7 虚拟专用网 VPN 和网络地址转换 NAT



